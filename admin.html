<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="permissions-policy" content="unload=()">
  <title>Trang Quản Trị - Trò chơi Online</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #146c43;
      color: #fff;
      text-align: center;
      margin: 0; padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    .admin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid rgba(255,255,255,0.2);
    }
    .admin-title {
      font-size: 28px;
      font-weight: bold;
    }
    .admin-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .admin-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #28a745;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: bold;
    }
    .admin-name {
      font-weight: bold;
    }
    .admin-logout {
      background: #dc3545;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      margin-left: 10px;
    }
    .admin-logout:hover {
      background: #c82333;
    }
    .admin-tabs {
      display: flex;
      margin-bottom: 20px;
      border-radius: 5px;
      overflow: hidden;
    }
    .admin-tab {
      flex: 1;
      padding: 15px;
      background: rgba(0,0,0,0.2);
      border: none;
      color: white;
      cursor: pointer;
      font-size: 16px;
    }
    .admin-tab.active {
      background: #28a745;
      font-weight: bold;
    }
    .tab-content {
      display: none;
      background: rgba(0,0,0,0.1);
      padding: 20px;
      border-radius: 10px;
    }
    .tab-content.active {
      display: block;
    }
    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: rgba(0,0,0,0.2);
      border-radius: 5px;
      overflow: hidden;
    }
    .data-table th, .data-table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .data-table th {
      background: rgba(0,0,0,0.3);
      font-weight: bold;
    }
    .data-table tr:hover {
      background: rgba(255,255,255,0.05);
    }
    .data-table tr:last-child td {
      border-bottom: none;
    }
    .action-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 5px;
    }
    .edit-btn {
      background: #ffc107;
      color: #000;
    }
    .delete-btn {
      background: #dc3545;
      color: #fff;
    }
    .stats-cards {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 30px;
    }
    .stats-card {
      background: rgba(0,0,0,0.2);
      padding: 20px;
      border-radius: 10px;
      text-align: center;
    }
    .stats-number {
      font-size: 36px;
      font-weight: bold;
      margin: 10px 0;
    }
    .stats-label {
      font-size: 14px;
      opacity: 0.8;
    }
    .search-bar {
      display: flex;
      margin-bottom: 20px;
    }
    .search-input {
      flex: 1;
      padding: 10px 15px;
      border: none;
      border-radius: 5px 0 0 5px;
      font-size: 16px;
    }
    .search-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 0 5px 5px 0;
      cursor: pointer;
    }
    .filter-options {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    .filter-select {
      padding: 8px 15px;
      border: none;
      border-radius: 5px;
      background: rgba(255,255,255,0.9);
    }
    .pagination {
      display: flex;
      justify-content: center;
      margin-top: 20px;
      gap: 5px;
    }
    .page-btn {
      padding: 8px 15px;
      border: none;
      border-radius: 5px;
      background: rgba(0,0,0,0.3);
      color: white;
      cursor: pointer;
    }
    .page-btn.active {
      background: #28a745;
      font-weight: bold;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 100;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: #1e7e34;
      padding: 20px;
      border-radius: 10px;
      width: 400px;
      max-width: 90%;
    }
    .modal-title {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 20px;
      text-align: center;
    }
    .form-group {
      margin-bottom: 15px;
      text-align: left;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      box-sizing: border-box;
    }
    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }
    .form-actions button {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .cancel-btn {
      background: rgba(0,0,0,0.3);
      color: white;
    }
    .save-btn {
      background: #28a745;
      color: white;
    }
    .error-message {
      color: #ff6b6b;
      margin-top: 5px;
      font-size: 14px;
      text-align: left;
    }
    .success-message {
      color: #28a745;
      margin-top: 5px;
      font-size: 14px;
      text-align: center;
      padding: 10px;
      background: rgba(40, 167, 69, 0.2);
      border-radius: 5px;
      margin-bottom: 15px;
    }
    .login-container {
      max-width: 400px;
      margin: 100px auto;
      background: rgba(0,0,0,0.2);
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
    }
    .login-title {
      font-size: 24px;
      margin-bottom: 30px;
    }
    .login-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      width: 100%;
      margin-top: 20px;
    }
    .login-btn:hover {
      background: #218838;
    }
  </style>
</head>
<body>
  <!-- Phần đăng nhập -->
  <div id="loginSection" class="login-container">
    <h1 class="login-title">Đăng Nhập Quản Trị</h1>
    <div class="form-group">
      <label for="adminEmail">Email</label>
      <input type="email" id="adminEmail" placeholder="Nhập email quản trị">
    </div>
    <div class="form-group">
      <label for="adminPassword">Mật khẩu</label>
      <input type="password" id="adminPassword" placeholder="Nhập mật khẩu">
    </div>
    <div id="loginError" class="error-message"></div>
    <button id="loginBtn" class="login-btn">Đăng Nhập</button>
    <div style="margin-top: 20px; text-align: center;">
      <p>Hoặc</p>
      <button id="googleLoginBtn" class="login-btn" style="background-color: #4285F4;">Đăng Nhập Bằng Google</button>
    </div>
  </div>

  <!-- Phần quản trị -->
  <div id="adminSection" class="container" style="display: none;">
    <div class="admin-header">
      <div class="admin-title">Trang Quản Trị</div>
      <div class="admin-info">
        <div class="admin-avatar" id="adminAvatar">A</div>
        <div class="admin-name" id="adminName">Admin</div>
        <button id="adminBtn" class="admin-btn" style="background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin-right: 10px;">Admin</button>
        <button id="logoutBtn" class="admin-logout">Đăng Xuất</button>
      </div>
    </div>
    
    <div class="stats-cards">
      <div class="stats-card">
        <div class="stats-number" id="totalUsers">0</div>
        <div class="stats-label">Tổng Người Dùng</div>
      </div>
      <div class="stats-card">
        <div class="stats-number" id="totalRooms">0</div>
        <div class="stats-label">Tổng Phòng</div>
      </div>
      <div class="stats-card">
        <div class="stats-number" id="activeGames">0</div>
        <div class="stats-label">Trò Chơi Đang Diễn Ra</div>
      </div>
      <div class="stats-card">
        <div class="stats-number" id="totalGames">0</div>
        <div class="stats-label">Tổng Trò Chơi Đã Chơi</div>
      </div>
    </div>
    
    <div class="admin-tabs">
      <button class="admin-tab active" data-tab="usersTab">Quản Lý Người Dùng</button>
      <button class="admin-tab" data-tab="roomsTab">Quản Lý Phòng</button>
      <button class="admin-tab" data-tab="gamesTab">Thống Kê Trò Chơi</button>
    </div>
    
    <!-- Tab Quản Lý Người Dùng -->
    <div id="usersTab" class="tab-content active">
      <div class="search-bar">
        <input type="text" id="userSearchInput" class="search-input" placeholder="Tìm kiếm người dùng...">
        <button id="userSearchBtn" class="search-btn">Tìm Kiếm</button>
      </div>
      
      <div class="filter-options">
        <select id="userTypeFilter" class="filter-select">
          <option value="all">Tất Cả Người Dùng</option>
          <option value="registered">Người Dùng Đã Đăng Ký</option>
          <option value="guest">Người Dùng Khách</option>
        </select>
        <select id="userSortBy" class="filter-select">
          <option value="newest">Mới Nhất</option>
          <option value="oldest">Cũ Nhất</option>
          <option value="points">Điểm Cao Nhất</option>
          <option value="games">Số Trận Nhiều Nhất</option>
        </select>
      </div>
      
      <table class="data-table" id="usersTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Tên</th>
            <th>Email</th>
            <th>Loại</th>
            <th>Điểm</th>
            <th>Số Trận</th>
            <th>Ngày Tạo</th>
            <th>Thao Tác</th>
          </tr>
        </thead>
        <tbody id="usersTableBody">
          <!-- Dữ liệu người dùng sẽ được thêm vào đây -->
        </tbody>
      </table>
      
      <div class="pagination" id="usersPagination">
        <!-- Các nút phân trang sẽ được thêm vào đây -->
      </div>
    </div>
    
    <!-- Tab Quản Lý Phòng -->
    <div id="roomsTab" class="tab-content">
      <div class="search-bar">
        <input type="text" id="roomSearchInput" class="search-input" placeholder="Tìm kiếm phòng...">
        <button id="roomSearchBtn" class="search-btn">Tìm Kiếm</button>
      </div>
      
      <div class="filter-options">
        <select id="roomTypeFilter" class="filter-select">
          <option value="all">Tất Cả Phòng</option>
          <option value="uno">UNO</option>
          <option value="chess">Cờ Vua</option>
        </select>
        <select id="roomStatusFilter" class="filter-select">
          <option value="all">Tất Cả Trạng Thái</option>
          <option value="waiting">Đang Chờ</option>
          <option value="playing">Đang Chơi</option>
        </select>
        <select id="roomSortBy" class="filter-select">
          <option value="newest">Mới Nhất</option>
          <option value="oldest">Cũ Nhất</option>
          <option value="players">Nhiều Người Chơi Nhất</option>
        </select>
      </div>
      
      <table class="data-table" id="roomsTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Tên Phòng</th>
            <th>Loại</th>
            <th>Chủ Phòng</th>
            <th>Số Người Chơi</th>
            <th>Trạng Thái</th>
            <th>Ngày Tạo</th>
            <th>Thao Tác</th>
          </tr>
        </thead>
        <tbody id="roomsTableBody">
          <!-- Dữ liệu phòng sẽ được thêm vào đây -->
        </tbody>
      </table>
      
      <div class="pagination" id="roomsPagination">
        <!-- Các nút phân trang sẽ được thêm vào đây -->
      </div>
    </div>
    
    <!-- Tab Thống Kê Trò Chơi -->
    <div id="gamesTab" class="tab-content">
      <div class="filter-options">
        <select id="gameTypeFilter" class="filter-select">
          <option value="all">Tất Cả Trò Chơi</option>
          <option value="uno">UNO</option>
          <option value="chess">Cờ Vua</option>
        </select>
        <select id="gameDateFilter" class="filter-select">
          <option value="all">Tất Cả Thời Gian</option>
          <option value="today">Hôm Nay</option>
          <option value="week">Tuần Này</option>
          <option value="month">Tháng Này</option>
        </select>
      </div>
      
      <table class="data-table" id="gamesTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Loại</th>
            <th>Phòng</th>
            <th>Người Chơi</th>
            <th>Người Thắng</th>
            <th>Thời Gian Chơi</th>
            <th>Ngày Chơi</th>
          </tr>
        </thead>
        <tbody id="gamesTableBody">
          <!-- Dữ liệu trò chơi sẽ được thêm vào đây -->
        </tbody>
      </table>
      
      <div class="pagination" id="gamesPagination">
        <!-- Các nút phân trang sẽ được thêm vào đây -->
      </div>
    </div>
  </div>
  
  <!-- Modal Chỉnh Sửa Người Dùng -->
  <div id="editUserModal" class="modal">
    <div class="modal-content">
      <div class="modal-title">Chỉnh Sửa Người Dùng</div>
      <div id="editUserSuccess" class="success-message" style="display: none;"></div>
      <div class="form-group">
        <label for="editUserName">Tên Hiển Thị</label>
        <input type="text" id="editUserName">
      </div>
      <div class="form-group">
        <label for="editUserEmail">Email</label>
        <input type="email" id="editUserEmail" disabled>
      </div>
      <div class="form-group">
        <label for="editUserPoints">Điểm</label>
        <input type="number" id="editUserPoints" min="0">
      </div>
      <div class="form-group">
        <label for="editUserUnoWins">Số Trận Thắng UNO</label>
        <input type="number" id="editUserUnoWins" min="0">
      </div>
      <div class="form-group">
        <label for="editUserChessWins">Số Trận Thắng Cờ Vua</label>
        <input type="number" id="editUserChessWins" min="0">
      </div>
      <div class="form-group">
        <label for="editUserTotalGames">Tổng Số Trận</label>
        <input type="number" id="editUserTotalGames" min="0">
      </div>
      <div id="editUserError" class="error-message"></div>
      <div class="form-actions">
        <button id="cancelEditUserBtn" class="cancel-btn">Hủy</button>
        <button id="saveUserBtn" class="save-btn">Lưu Thay Đổi</button>
      </div>
    </div>
  </div>
  
  <!-- Modal Xóa Phòng -->
  <div id="deleteRoomModal" class="modal">
    <div class="modal-content">
      <div class="modal-title">Xác Nhận Xóa Phòng</div>
      <p>Bạn có chắc chắn muốn xóa phòng này không? Hành động này không thể hoàn tác.</p>
      <div id="deleteRoomError" class="error-message"></div>
      <div class="form-actions">
        <button id="cancelDeleteRoomBtn" class="cancel-btn">Hủy</button>
        <button id="confirmDeleteRoomBtn" class="delete-btn">Xóa Phòng</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  
  <script>
    // Cấu hình Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyBgITWCnQO7pW2-VOAgpKFsK6GN8H037HM",
        authDomain: "masoi-92684.firebaseapp.com",
        databaseURL: "https://masoi-92684-default-rtdb.firebaseio.com",
        projectId: "masoi-92684",
        storageBucket: "masoi-92684.firebasestorage.app",
        messagingSenderId: "1030518945375",
        appId: "1:1030518945375:web:a531a0233c0dcbde120dea",
        measurementId: "G-QNS4GVQ178"
    };
    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();
    
    // Biến lưu trữ thông tin admin
    let currentAdmin = null;
    
    // Biến lưu trữ dữ liệu phân trang
    const pagination = {
      users: { currentPage: 1, itemsPerPage: 10, totalPages: 1 },
      rooms: { currentPage: 1, itemsPerPage: 10, totalPages: 1 },
      games: { currentPage: 1, itemsPerPage: 10, totalPages: 1 }
    };
    
    // Biến lưu trữ dữ liệu hiện tại
    let currentData = {
      users: [],
      rooms: [],
      games: []
    };
    
    // Biến lưu trữ ID người dùng/phòng đang chỉnh sửa
    let currentEditId = null;
    
    // Xử lý đăng nhập admin
    document.getElementById('loginBtn').addEventListener('click', () => {
      const email = document.getElementById('adminEmail').value.trim();
      const password = document.getElementById('adminPassword').value;
      const errorElement = document.getElementById('loginError');
      
      if (!email || !password) {
        errorElement.textContent = 'Vui lòng nhập đầy đủ thông tin!';
        return;
      }
      
      // Kiểm tra email admin
      const adminEmails = ['micovan108@gmail.com', 'admin@example.com'];
      if (!adminEmails.includes(email)) {
        errorElement.textContent = 'Email không có quyền truy cập trang quản trị!';
        return;
      }
      
      auth.signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
          // Đăng nhập thành công
          currentAdmin = userCredential.user;
          document.getElementById('loginSection').style.display = 'none';
          document.getElementById('adminSection').style.display = 'block';
          
          // Cập nhật thông tin admin
          document.getElementById('adminName').textContent = currentAdmin.displayName || 'Admin';
          document.getElementById('adminAvatar').textContent = (currentAdmin.displayName || 'A').charAt(0).toUpperCase();
          
          // Tải dữ liệu ban đầu
          loadDashboardData();
          loadUsers();
        })
        .catch((error) => {
          // Xử lý lỗi đăng nhập
          switch(error.code) {
            case 'auth/user-not-found':
              errorElement.textContent = 'Tài khoản không tồn tại!';
              break;
            case 'auth/wrong-password':
              errorElement.textContent = 'Mật khẩu không chính xác!';
              break;
            default:
              errorElement.textContent = 'Đăng nhập thất bại: ' + error.message;
          }
        });
    });
    
    // Xử lý đăng xuất
    document.getElementById('logoutBtn').addEventListener('click', () => {
      auth.signOut().then(() => {
        currentAdmin = null;
        document.getElementById('loginSection').style.display = 'block';
        document.getElementById('adminSection').style.display = 'none';
        document.getElementById('adminEmail').value = '';
        document.getElementById('adminPassword').value = '';
        document.getElementById('loginError').textContent = '';
      }).catch((error) => {
        console.error('Đăng xuất thất bại:', error);
      });
    });
    
    // Xử lý nút admin
    document.getElementById('adminBtn').addEventListener('click', () => {
      window.location.href = 'admin.html';
    });
    
    // Xử lý chuyển tab
    document.querySelectorAll('.admin-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        // Xóa class active từ tất cả các tab và nội dung
        document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        
        // Thêm class active cho tab được chọn
        tab.classList.add('active');
        const tabId = tab.getAttribute('data-tab');
        document.getElementById(tabId).classList.add('active');
        
        // Tải dữ liệu cho tab được chọn
        if (tabId === 'usersTab') {
          loadUsers();
        } else if (tabId === 'roomsTab') {
          loadRooms();
        } else if (tabId === 'gamesTab') {
          loadGames();
        }
      });
    });
    
    // Hàm tải dữ liệu tổng quan cho dashboard
    function loadDashboardData() {
      // Đếm tổng số người dùng
      db.ref('users').once('value', snapshot => {
        if (!snapshot.exists()) {
          document.getElementById('totalUsers').textContent = 0;
          return;
        }
        
        const users = snapshot.val();
        const userIds = Object.keys(users);
        
        // Lọc ra người dùng không phải khách
        const registeredUsers = userIds.filter(userId => !userId.startsWith('guest_'));
        const totalUsers = registeredUsers.length;
        
        document.getElementById('totalUsers').textContent = totalUsers;
      });
      
      // Đếm tổng số phòng và phòng đang chơi
      db.ref('rooms').once('value', snapshot => {
        if (!snapshot.exists()) {
          document.getElementById('totalRooms').textContent = 0;
          document.getElementById('activeGames').textContent = 0;
          return;
        }
        
        const rooms = snapshot.val();
        const roomIds = Object.keys(rooms);
        const totalRooms = roomIds.length;
        
        // Đếm số phòng đang chơi
        let activeGames = 0;
        roomIds.forEach(roomId => {
          if (rooms[roomId].status === 'playing') {
            activeGames++;
          }
        });
        
        document.getElementById('totalRooms').textContent = totalRooms;
        document.getElementById('activeGames').textContent = activeGames;
      });
      
      // Đếm tổng số trận đã chơi
      db.ref('games').once('value', snapshot => {
        if (!snapshot.exists()) {
          document.getElementById('totalGames').textContent = 0;
          return;
        }
        
        const games = snapshot.val();
        const gameIds = Object.keys(games);
        
        // Chỉ đếm các trận đã hoàn thành (có winner)
        const completedGames = gameIds.filter(gameId => games[gameId].winner);
        const totalGames = completedGames.length;
        
        document.getElementById('totalGames').textContent = totalGames;
      });
    }
    
    // Hàm tải danh sách người dùng
    function loadUsers() {
      // Lấy dữ liệu người dùng
      db.ref('users').once('value', snapshot => {
        if (!snapshot.exists()) {
          document.getElementById('usersTableBody').innerHTML = '<tr><td colspan="8" style="text-align: center;">Không có dữ liệu người dùng</td></tr>';
          return;
        }
        
        const users = snapshot.val();
        const userIds = Object.keys(users);
        
        // Lấy dữ liệu về các trận đấu để tính số trận đã chơi
        db.ref('games').once('value', gamesSnapshot => {
          const games = gamesSnapshot.exists() ? gamesSnapshot.val() : {};
          const gameIds = Object.keys(games);
          
          // Đếm số trận đã chơi cho mỗi người dùng
          const userGames = {};
          gameIds.forEach(gameId => {
            const game = games[gameId];
            if (game.whitePlayer && !game.whitePlayer.startsWith('guest_')) {
              userGames[game.whitePlayer] = (userGames[game.whitePlayer] || 0) + 1;
            }
            if (game.blackPlayer && !game.blackPlayer.startsWith('guest_')) {
              userGames[game.blackPlayer] = (userGames[game.blackPlayer] || 0) + 1;
            }
          });
          
          // Chuyển đổi dữ liệu thành mảng để dễ dàng sắp xếp và lọc
          currentData.users = userIds.map(userId => {
            return {
              id: userId,
              ...users[userId],
              type: userId.startsWith('guest_') ? 'Khách' : 'Đã Đăng Ký',
              totalGames: userGames[userId] || 0
            };
          });
          
          // Áp dụng bộ lọc và sắp xếp
          applyUserFilters();
        });
      });
    }
    
    // Hàm áp dụng bộ lọc cho danh sách người dùng
    function applyUserFilters() {
      const searchTerm = document.getElementById('userSearchInput').value.toLowerCase();
      const typeFilter = document.getElementById('userTypeFilter').value;
      const sortBy = document.getElementById('userSortBy').value;
      
      // Lọc dữ liệu
      let filteredUsers = currentData.users.filter(user => {
        // Lọc theo từ khóa tìm kiếm
        const matchesSearch = (user.displayName && user.displayName.toLowerCase().includes(searchTerm)) || 
                             (user.email && user.email.toLowerCase().includes(searchTerm));
        
        // Lọc theo loại người dùng
        const matchesType = typeFilter === 'all' || 
                           (typeFilter === 'registered' && !user.id.startsWith('guest_')) || 
                           (typeFilter === 'guest' && user.id.startsWith('guest_'));
        
        return matchesSearch && matchesType;
      });
      
      // Sắp xếp dữ liệu
      filteredUsers.sort((a, b) => {
        switch (sortBy) {
          case 'newest':
            return (b.createdAt || 0) - (a.createdAt || 0);
          case 'oldest':
            return (a.createdAt || 0) - (b.createdAt || 0);
          case 'points':
            return (b.points || 0) - (a.points || 0);
          case 'games':
            return (b.totalGames || 0) - (a.totalGames || 0);
          default:
            return 0;
        }
      });
      
      // Cập nhật phân trang
      pagination.users.totalPages = Math.ceil(filteredUsers.length / pagination.users.itemsPerPage);
      if (pagination.users.currentPage > pagination.users.totalPages) {
        pagination.users.currentPage = 1;
      }
      
      // Lấy dữ liệu cho trang hiện tại
      const startIndex = (pagination.users.currentPage - 1) * pagination.users.itemsPerPage;
      const endIndex = startIndex + pagination.users.itemsPerPage;
      const paginatedUsers = filteredUsers.slice(startIndex, endIndex);
      
      // Hiển thị dữ liệu
      renderUsers(paginatedUsers);
      renderPagination('users', pagination.users.totalPages);
    }
    
    // Hàm hiển thị danh sách người dùng
    function renderUsers(users) {
      const tableBody = document.getElementById('usersTableBody');
      
      if (users.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Không tìm thấy người dùng nào</td></tr>';
        return;
      }
      
      tableBody.innerHTML = '';
      
      users.forEach(user => {
        const row = document.createElement('tr');
        
        // Định dạng ngày tạo
        const createdDate = user.createdAt ? new Date(user.createdAt).toLocaleDateString('vi-VN') : 'N/A';
        
        row.innerHTML = `
          <td>${user.id}</td>
          <td>${user.displayName || 'N/A'}</td>
          <td>${user.email || 'N/A'}</td>
          <td>${user.type}</td>
          <td>${user.points || 0}</td>
          <td>${user.totalGames || 0}</td>
          <td>${createdDate}</td>
          <td>
            <button class="action-btn edit-btn" data-user-id="${user.id}">Sửa</button>
          </td>
        `;
        
        tableBody.appendChild(row);
      });
      
      // Thêm sự kiện cho các nút chỉnh sửa
      document.querySelectorAll('.edit-btn[data-user-id]').forEach(button => {
        button.addEventListener('click', () => {
          const userId = button.getAttribute('data-user-id');
          openEditUserModal(userId);
        });
      });
    }
    
    // Hàm mở modal chỉnh sửa người dùng
    function openEditUserModal(userId) {
      const user = currentData.users.find(u => u.id === userId);
      if (!user) return;
      
      currentEditId = userId;
      
      // Điền thông tin người dùng vào form
      document.getElementById('editUserName').value = user.displayName || '';
      document.getElementById('editUserEmail').value = user.email || '';
      document.getElementById('editUserPoints').value = user.points || 0;
      document.getElementById('editUserUnoWins').value = user.unoWins || 0;
      document.getElementById('editUserChessWins').value = user.chessWins || 0;
      document.getElementById('editUserTotalGames').value = user.totalGames || 0;
      
      // Xóa thông báo lỗi và thành công
      document.getElementById('editUserError').textContent = '';
      document.getElementById('editUserSuccess').style.display = 'none';
      
      // Hiển thị modal
      document.getElementById('editUserModal').style.display = 'flex';
    }
    
    // Xử lý lưu thay đổi người dùng
    document.getElementById('saveUserBtn').addEventListener('click', () => {
      if (!currentEditId) return;
      
      const name = document.getElementById('editUserName').value.trim();
      const points = parseInt(document.getElementById('editUserPoints').value) || 0;
      const unoWins = parseInt(document.getElementById('editUserUnoWins').value) || 0;
      const chessWins = parseInt(document.getElementById('editUserChessWins').value) || 0;
      const totalGames = parseInt(document.getElementById('editUserTotalGames').value) || 0;
      const errorElement = document.getElementById('editUserError');
      
      if (!name) {
        errorElement.textContent = 'Vui lòng nhập tên hiển thị!';
        return;
      }
      
      // Cập nhật thông tin người dùng trong database
      db.ref('users/' + currentEditId).update({
        displayName: name,
        points: points,
        unoWins: unoWins,
        chessWins: chessWins,
        totalGames: totalGames
      }).then(() => {
        // Hiển thị thông báo thành công
        const successElement = document.getElementById('editUserSuccess');
        successElement.textContent = 'Cập nhật thông tin người dùng thành công!';
        successElement.style.display = 'block';
        
        // Tải lại danh sách người dùng
        loadUsers();
        
        // Đóng modal sau 2 giây
        setTimeout(() => {
          document.getElementById('editUserModal').style.display = 'none';
          currentEditId = null;
        }, 2000);
      }).catch(error => {
        errorElement.textContent = 'Cập nhật thất bại: ' + error.message;
      });
    });
    
    // Xử lý đóng modal chỉnh sửa người dùng
    document.getElementById('cancelEditUserBtn').addEventListener('click', () => {
      document.getElementById('editUserModal').style.display = 'none';
      currentEditId = null;
    });
    
    // Hàm tải danh sách phòng
    function loadRooms() {
      db.ref('rooms').once('value', snapshot => {
        if (!snapshot.exists()) {
          document.getElementById('roomsTableBody').innerHTML = '<tr><td colspan="8" style="text-align: center;">Không có dữ liệu phòng</td></tr>';
          return;
        }
        
        const rooms = snapshot.val();
        const roomIds = Object.keys(rooms);
        
        // Chuyển đổi dữ liệu thành mảng để dễ dàng sắp xếp và lọc
        currentData.rooms = roomIds.map(roomId => {
          const room = rooms[roomId];
          const playerCount = room.players ? Object.keys(room.players).length : 0;
          
          // Tìm tên chủ phòng từ danh sách người chơi
          let hostName = 'Không xác định';
          if (room.players && room.host) {
            const hostPlayer = room.players[room.host];
            if (hostPlayer && hostPlayer.displayName) {
              hostName = hostPlayer.displayName;
            }
          }
          
          return {
            id: roomId,
            name: room.name,
            gameType: room.gameType,
            host: room.host,
            hostName: hostName,
            playerCount: playerCount,
            status: room.started ? 'playing' : 'waiting',
            createdAt: room.createdAt
          };
        });
        
        // Áp dụng bộ lọc và sắp xếp
        applyRoomFilters();
      });
    }
    
    // Hàm áp dụng bộ lọc cho danh sách phòng
    function applyRoomFilters() {
      const searchTerm = document.getElementById('roomSearchInput').value.toLowerCase();
      const typeFilter = document.getElementById('roomTypeFilter').value;
      const statusFilter = document.getElementById('roomStatusFilter').value;
      const sortBy = document.getElementById('roomSortBy').value;
      
      // Lọc dữ liệu
      let filteredRooms = currentData.rooms.filter(room => {
        // Lọc theo từ khóa tìm kiếm
        const matchesSearch = room.name.toLowerCase().includes(searchTerm) || 
                             (room.host && room.host.toLowerCase().includes(searchTerm));
        
        // Lọc theo loại phòng
        const matchesType = typeFilter === 'all' || room.gameType === typeFilter;
        
        // Lọc theo trạng thái
        const matchesStatus = statusFilter === 'all' || room.status === statusFilter;
        
        return matchesSearch && matchesType && matchesStatus;
      });
      
      // Sắp xếp dữ liệu
      filteredRooms.sort((a, b) => {
        switch (sortBy) {
          case 'newest':
            return (b.createdAt || 0) - (a.createdAt || 0);
          case 'oldest':
            return (a.createdAt || 0) - (b.createdAt || 0);
          case 'players':
            return b.playerCount - a.playerCount;
          default:
            return 0;
        }
      });
      
      // Cập nhật phân trang
      pagination.rooms.totalPages = Math.ceil(filteredRooms.length / pagination.rooms.itemsPerPage);
      if (pagination.rooms.currentPage > pagination.rooms.totalPages) {
        pagination.rooms.currentPage = 1;
      }
      
      // Lấy dữ liệu cho trang hiện tại
      const startIndex = (pagination.rooms.currentPage - 1) * pagination.rooms.itemsPerPage;
      const endIndex = startIndex + pagination.rooms.itemsPerPage;
      const paginatedRooms = filteredRooms.slice(startIndex, endIndex);
      
      // Hiển thị dữ liệu
      renderRooms(paginatedRooms);
      renderPagination('rooms', pagination.rooms.totalPages);
    }
    
    // Hàm hiển thị danh sách phòng
    function renderRooms(rooms) {
      const tableBody = document.getElementById('roomsTableBody');
      
      if (rooms.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Không tìm thấy phòng nào</td></tr>';
        return;
      }
      
      tableBody.innerHTML = '';
      
      rooms.forEach(room => {
        const row = document.createElement('tr');
        
        // Định dạng ngày tạo
        const createdDate = room.createdAt ? new Date(room.createdAt).toLocaleDateString('vi-VN') : 'N/A';
        
        // Định dạng loại phòng
        const gameType = room.gameType === 'uno' ? 'UNO' : 'Cờ Vua';
        
        // Định dạng trạng thái
        const status = room.status === 'playing' ? 'Đang chơi' : 'Đang chờ';
        
        row.innerHTML = `
          <td>${room.id}</td>
          <td>${room.name}</td>
          <td>${gameType}</td>
          <td>${room.hostName || 'Không xác định'}</td>
          <td>${room.playerCount}</td>
          <td>${status}</td>
          <td>${createdDate}</td>
          <td>
            <button class="action-btn delete-btn" data-room-id="${room.id}">Xóa</button>
          </td>
        `;
        
        tableBody.appendChild(row);
      });
      
      // Thêm sự kiện cho các nút xóa
      document.querySelectorAll('.delete-btn[data-room-id]').forEach(button => {
        button.addEventListener('click', () => {
          const roomId = button.getAttribute('data-room-id');
          openDeleteRoomModal(roomId);
        });
      });
    }
    
    // Hàm mở modal xóa phòng
    function openDeleteRoomModal(roomId) {
      currentEditId = roomId;
      
      // Xóa thông báo lỗi
      document.getElementById('deleteRoomError').textContent = '';
      
      // Hiển thị modal
      document.getElementById('deleteRoomModal').style.display = 'flex';
    }
    
    // Xử lý xóa phòng
    document.getElementById('confirmDeleteRoomBtn').addEventListener('click', () => {
      if (!currentEditId) return;
      
      // Xóa phòng khỏi database
      db.ref('rooms/' + currentEditId).remove()
        .then(() => {
          // Đóng modal
          document.getElementById('deleteRoomModal').style.display = 'none';
          currentEditId = null;
          
          // Tải lại danh sách phòng và dữ liệu dashboard
          loadRooms();
          loadDashboardData();
        })
        .catch(error => {
          document.getElementById('deleteRoomError').textContent = 'Xóa phòng thất bại: ' + error.message;
        });
    });
    
    // Xử lý đóng modal xóa phòng
    document.getElementById('cancelDeleteRoomBtn').addEventListener('click', () => {
      document.getElementById('deleteRoomModal').style.display = 'none';
      currentEditId = null;
    });
    
    // Hàm tải danh sách trò chơi đã chơi
    function loadGames() {
      db.ref('games').once('value', snapshot => {
        if (!snapshot.exists()) {
          document.getElementById('gamesTableBody').innerHTML = '<tr><td colspan="7" style="text-align: center;">Không có dữ liệu trò chơi</td></tr>';
          return;
        }
        
        const games = snapshot.val();
        const gameIds = Object.keys(games);
        
        // Chuyển đổi dữ liệu thành mảng để dễ dàng sắp xếp và lọc
        currentData.games = gameIds.map(gameId => {
          const game = games[gameId];
          
          // Đảm bảo các trường dữ liệu cần thiết
          let players = [];
          if (game.players) {
            // Nếu players là object, chuyển đổi thành mảng tên người chơi
            if (typeof game.players === 'object' && !Array.isArray(game.players)) {
              players = Object.values(game.players)
                .filter(player => player && player.displayName)
                .map(player => player.displayName);
            } else if (Array.isArray(game.players)) {
              players = game.players;
            }
          }
          
          return {
            id: gameId,
            gameType: game.gameType || 'unknown',
            roomName: game.roomName || 'Không xác định',
            players: players,
            winner: game.winner || 'Không xác định',
            startTime: game.startTime || null,
            endTime: game.endTime || null
          };
        });
        
        // Áp dụng bộ lọc và sắp xếp
        applyGameFilters();
      });
    }
    
    // Hàm áp dụng bộ lọc cho danh sách trò chơi
    function applyGameFilters() {
      const typeFilter = document.getElementById('gameTypeFilter').value;
      const dateFilter = document.getElementById('gameDateFilter').value;
      
      // Lấy thời gian hiện tại
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
      const weekStart = today - 6 * 24 * 60 * 60 * 1000; // 7 ngày trước
      const monthStart = new Date(now.getFullYear(), now.getMonth(), 1).getTime();
      
      // Lọc dữ liệu
      let filteredGames = currentData.games.filter(game => {
        // Lọc theo loại trò chơi
        const matchesType = typeFilter === 'all' || game.gameType === typeFilter;
        
        // Lọc theo thời gian
        let matchesDate = true;
        if (dateFilter !== 'all' && game.endTime) {
          const gameTime = game.endTime;
          
          if (dateFilter === 'today') {
            matchesDate = gameTime >= today;
          } else if (dateFilter === 'week') {
            matchesDate = gameTime >= weekStart;
          } else if (dateFilter === 'month') {
            matchesDate = gameTime >= monthStart;
          }
        }
        
        return matchesType && matchesDate;
      });
      
      // Sắp xếp theo thời gian gần nhất
      filteredGames.sort((a, b) => (b.endTime || 0) - (a.endTime || 0));
      
      // Cập nhật phân trang
      pagination.games.totalPages = Math.ceil(filteredGames.length / pagination.games.itemsPerPage);
      if (pagination.games.currentPage > pagination.games.totalPages) {
        pagination.games.currentPage = 1;
      }
      
      // Lấy dữ liệu cho trang hiện tại
      const startIndex = (pagination.games.currentPage - 1) * pagination.games.itemsPerPage;
      const endIndex = startIndex + pagination.games.itemsPerPage;
      const paginatedGames = filteredGames.slice(startIndex, endIndex);
      
      // Hiển thị dữ liệu
      renderGames(paginatedGames);
      renderPagination('games', pagination.games.totalPages);
    }
    
    // Hàm hiển thị danh sách trò chơi
    function renderGames(games) {
      const tableBody = document.getElementById('gamesTableBody');
      
      if (games.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Không tìm thấy trò chơi nào</td></tr>';
        return;
      }
      
      tableBody.innerHTML = '';
      
      games.forEach(game => {
        const row = document.createElement('tr');
        
        // Định dạng thời gian chơi
        const playTime = game.startTime && game.endTime ? 
                        Math.floor((game.endTime - game.startTime) / 60000) + ' phút' : 'N/A';
        
        // Định dạng ngày chơi
        const playDate = game.endTime ? new Date(game.endTime).toLocaleDateString('vi-VN') : 'N/A';
        
        // Định dạng loại trò chơi
        const gameType = game.gameType === 'uno' ? 'UNO' : 'Cờ Vua';
        
        row.innerHTML = `
          <td>${game.id}</td>
          <td>${gameType}</td>
          <td>${game.roomName || 'N/A'}</td>
          <td>${game.players ? game.players.join(', ') : 'N/A'}</td>
          <td>${game.winner || 'N/A'}</td>
          <td>${playTime}</td>
          <td>${playDate}</td>
        `;
        
        tableBody.appendChild(row);
      });
    }
    
    // Hàm hiển thị phân trang
    function renderPagination(type, totalPages) {
      const paginationElement = document.getElementById(`${type}Pagination`);
      paginationElement.innerHTML = '';
      
      if (totalPages <= 1) return;
      
      // Nút trang trước
      const prevButton = document.createElement('button');
      prevButton.className = 'page-btn';
      prevButton.textContent = '«';
      prevButton.disabled = pagination[type].currentPage === 1;
      prevButton.addEventListener('click', () => {
        if (pagination[type].currentPage > 1) {
          pagination[type].currentPage--;
          if (type === 'users') applyUserFilters();
          else if (type === 'rooms') applyRoomFilters();
          else if (type === 'games') applyGameFilters();
        }
      });
      paginationElement.appendChild(prevButton);
      
      // Các nút trang
      const maxVisiblePages = 5;
      let startPage = Math.max(1, pagination[type].currentPage - Math.floor(maxVisiblePages / 2));
      let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
      
      if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
      }
      
      for (let i = startPage; i <= endPage; i++) {
        const pageButton = document.createElement('button');
        pageButton.className = 'page-btn' + (i === pagination[type].currentPage ? ' active' : '');
        pageButton.textContent = i;
        pageButton.addEventListener('click', () => {
          pagination[type].currentPage = i;
          if (type === 'users') applyUserFilters();
          else if (type === 'rooms') applyRoomFilters();
          else if (type === 'games') applyGameFilters();
        });
        paginationElement.appendChild(pageButton);
      }
      
      // Nút trang sau
      const nextButton = document.createElement('button');
      nextButton.className = 'page-btn';
      nextButton.textContent = '»';
      nextButton.disabled = pagination[type].currentPage === totalPages;
      nextButton.addEventListener('click', () => {
        if (pagination[type].currentPage < totalPages) {
          pagination[type].currentPage++;
          if (type === 'users') applyUserFilters();
          else if (type === 'rooms') applyRoomFilters();
          else if (type === 'games') applyGameFilters();
        }
      });
      paginationElement.appendChild(nextButton);
    }
    
    // Xử lý tìm kiếm người dùng
    document.getElementById('userSearchBtn').addEventListener('click', () => {
      applyUserFilters();
    });
    
    // Xử lý tìm kiếm phòng
    document.getElementById('roomSearchBtn').addEventListener('click', () => {
      applyRoomFilters();
    });
    
    // Xử lý thay đổi bộ lọc người dùng
    document.getElementById('userTypeFilter').addEventListener('change', applyUserFilters);
    document.getElementById('userSortBy').addEventListener('change', applyUserFilters);
    
    // Xử lý thay đổi bộ lọc phòng
    document.getElementById('roomTypeFilter').addEventListener('change', applyRoomFilters);
    document.getElementById('roomStatusFilter').addEventListener('change', applyRoomFilters);
    document.getElementById('roomSortBy').addEventListener('change', applyRoomFilters);
    
    // Xử lý thay đổi bộ lọc trò chơi
    document.getElementById('gameTypeFilter').addEventListener('change', applyGameFilters);
    document.getElementById('gameDateFilter').addEventListener('change', applyGameFilters);
    
    // Xử lý nhập tìm kiếm khi nhấn Enter
    document.getElementById('userSearchInput').addEventListener('keyup', event => {
      if (event.key === 'Enter') {
        applyUserFilters();
      }
    });
    
    document.getElementById('roomSearchInput').addEventListener('keyup', event => {
      if (event.key === 'Enter') {
        applyRoomFilters();
      }
    });
    
    // Xử lý đăng nhập bằng Google
    document.getElementById('googleLoginBtn').addEventListener('click', () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider)
        .then((result) => {
          // Kiểm tra quyền admin
          const adminEmails = ['micovan108@gmail.com', 'admin@example.com'];
          if (!adminEmails.includes(result.user.email)) {
            auth.signOut().then(() => {
              document.getElementById('loginError').textContent = 'Tài khoản Google không có quyền truy cập trang quản trị!';
            });
            return;
          }
          
          // Đăng nhập thành công
          currentAdmin = result.user;
          document.getElementById('loginSection').style.display = 'none';
          document.getElementById('adminSection').style.display = 'block';
          
          // Cập nhật thông tin admin
          document.getElementById('adminName').textContent = currentAdmin.displayName || 'Admin';
          document.getElementById('adminAvatar').textContent = (currentAdmin.displayName || 'A').charAt(0).toUpperCase();
          
          // Tải dữ liệu ban đầu
          loadDashboardData();
          loadUsers();
        })
        .catch((error) => {
          document.getElementById('loginError').textContent = 'Lỗi đăng nhập: ' + error.message;
        });
    });
    
    // Không cần nút truy cập trang admin từ trang chủ vì nút đã có trong trangchu.html
    
    // Kiểm tra trạng thái đăng nhập khi trang web được tải
    window.addEventListener('DOMContentLoaded', () => {
      // Kiểm tra thông tin người dùng từ localStorage
      const userInfo = JSON.parse(localStorage.getItem('userInfo'));
      
      // Kiểm tra quyền admin bằng email từ localStorage trước
      const adminEmails = ['micovan108@gmail.com', 'admin@example.com'];
      
      if (userInfo && adminEmails.includes(userInfo.email)) {
        // Người dùng admin đã đăng nhập qua localStorage
        currentAdmin = userInfo;
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('adminSection').style.display = 'block';
        
        // Cập nhật thông tin admin
        document.getElementById('adminName').textContent = currentAdmin.displayName || 'Admin';
        document.getElementById('adminAvatar').textContent = (currentAdmin.displayName || 'A').charAt(0).toUpperCase();
        
        // Tải dữ liệu ban đầu
        loadDashboardData();
        loadUsers();
        return; // Không cần kiểm tra Firebase Auth nếu đã xác thực qua localStorage
      }
      
      // Nếu không có thông tin trong localStorage, kiểm tra Firebase Auth
      auth.onAuthStateChanged(user => {
        // Kiểm tra quyền admin bằng email
        if (user && adminEmails.includes(user.email)) {
          // Người dùng admin đã đăng nhập
          currentAdmin = user;
          
          // Lưu thông tin vào localStorage để lần sau không cần đăng nhập lại
          localStorage.setItem('userInfo', JSON.stringify({
            uid: user.uid,
            displayName: user.displayName,
            email: user.email,
            isGuest: false,
            photoURL: user.photoURL || null
          }));
          
          document.getElementById('loginSection').style.display = 'none';
          document.getElementById('adminSection').style.display = 'block';
          
          // Cập nhật thông tin admin
          document.getElementById('adminName').textContent = currentAdmin.displayName || 'Admin';
          document.getElementById('adminAvatar').textContent = (currentAdmin.displayName || 'A').charAt(0).toUpperCase();
          
          // Tải dữ liệu ban đầu
          loadDashboardData();
          loadUsers();
        } else if (user) {
          // Người dùng đã đăng nhập nhưng không phải admin
          auth.signOut().then(() => {
            document.getElementById('loginError').textContent = 'Tài khoản không có quyền truy cập trang quản trị!';
          });
        }
      });
    });
  </script>
</body>
</html>