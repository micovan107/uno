<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Trò chơi Online với Firebase</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #146c43;
      color: #fff;
      text-align: center;
      margin: 0; padding: 20px;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    .game-selection {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin-top: 50px;
    }
    .game-card {
      background: #1e7e34;
      padding: 20px;
      border-radius: 10px;
      width: 300px;
      box-shadow: 0 0 15px rgba(0,0,0,0.5);
      transition: transform 0.3s;
      cursor: pointer;
    }
    .game-card:hover {
      transform: translateY(-10px);
    }
    .game-icon {
      font-size: 60px;
      margin-bottom: 20px;
    }
    .game-title {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 15px;
    }
    .game-description {
      font-size: 16px;
      margin-bottom: 20px;
    }
    .player-count {
      background: rgba(255,255,255,0.1);
      padding: 8px;
      border-radius: 5px;
      display: inline-block;
      margin-bottom: 15px;
    }
    .btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .btn:hover {
      background: #218838;
    }
    .btn-primary {
      background: #007bff;
    }
    .btn-primary:hover {
      background: #0069d9;
    }
    .btn-danger {
      background: #dc3545;
    }
    .btn-danger:hover {
      background: #c82333;
    }
    .btn-google {
      background: #db4437;
    }
    .btn-google:hover {
      background: #c53929;
    }
    /* Modal nhập tên */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 100;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: #1e7e34;
      padding: 20px;
      border-radius: 10px;
      width: 350px;
      text-align: center;
    }
    .input-group {
      margin-bottom: 15px;
    }
    .input-group input {
      padding: 10px;
      width: 90%;
      border-radius: 5px;
      border: none;
      font-size: 16px;
    }
    .input-group label {
      display: block;
      text-align: left;
      margin-left: 5%;
      margin-bottom: 5px;
      font-weight: bold;
    }
    .auth-options {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin: 15px 0;
    }
    .auth-divider {
      display: flex;
      align-items: center;
      margin: 15px 0;
    }
    .auth-divider::before,
    .auth-divider::after {
      content: "";
      flex: 1;
      border-bottom: 1px solid rgba(255,255,255,0.3);
    }
    .auth-divider span {
      padding: 0 10px;
      color: rgba(255,255,255,0.7);
    }
    .tab-buttons {
      display: flex;
      margin-bottom: 20px;
    }
    .tab-button {
      flex: 1;
      padding: 10px;
      background: rgba(0,0,0,0.2);
      border: none;
      color: white;
      cursor: pointer;
    }
    .tab-button.active {
      background: #28a745;
      font-weight: bold;
    }
    .tab-button:first-child {
      border-top-left-radius: 5px;
      border-bottom-left-radius: 5px;
    }
    .tab-button:last-child {
      border-top-right-radius: 5px;
      border-bottom-right-radius: 5px;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .user-profile {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(0,0,0,0.2);
      padding: 10px 15px;
      border-radius: 50px;
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
    }
    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #28a745;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: bold;
    }
    .user-info {
      text-align: left;
    }
    .user-name {
      font-weight: bold;
      font-size: 16px;
    }
    .user-points {
      font-size: 14px;
      color: rgba(255,255,255,0.8);
    }
    .profile-dropdown {
      position: absolute;
      top: 70px;
      right: 20px;
      background: #1e7e34;
      border-radius: 10px;
      padding: 15px;
      width: 250px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      display: none;
      z-index: 50;
    }
    .profile-dropdown.show {
      display: block;
    }
    .profile-stats {
      margin: 15px 0;
      padding: 10px;
      background: rgba(0,0,0,0.1);
      border-radius: 5px;
    }
    .stat-item {
      display: flex;
      justify-content: space-between;
      margin: 5px 0;
    }
    .create-room-btn {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: #28a745;
      color: white;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      transition: transform 0.2s, background-color 0.2s;
    }
    .create-room-btn:hover {
      transform: scale(1.1);
      background: #218838;
    }
    
    /* CSS cho khung chat */
    .chat-container {
      position: fixed;
      bottom: 30px;
      left: 30px;
      width: 300px;
      height: 400px;
      background: rgba(0, 0, 0, 0.7);
      border-radius: 10px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
      z-index: 100;
      transition: all 0.3s ease;
    }
    .chat-header {
      background: rgba(30, 126, 52, 0.8);
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }
    .chat-title {
      font-weight: bold;
      font-size: 16px;
    }
    .chat-toggle {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 18px;
    }
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .chat-message {
      padding: 8px 12px;
      border-radius: 15px;
      max-width: 80%;
      word-break: break-word;
    }
    .chat-message.sent {
      align-self: flex-end;
      background: #28a745;
    }
    .chat-message.received {
      align-self: flex-start;
      background: #343a40;
    }
    .message-sender {
      font-size: 12px;
      font-weight: bold;
      margin-bottom: 3px;
    }
    .message-time {
      font-size: 10px;
      opacity: 0.7;
      text-align: right;
      margin-top: 2px;
    }
    .chat-input-container {
      display: flex;
      padding: 10px;
      background: rgba(30, 126, 52, 0.8);
    }
    .chat-input {
      flex: 1;
      padding: 8px 12px;
      border: none;
      border-radius: 20px;
      margin-right: 8px;
      background: rgba(255, 255, 255, 0.9);
    }
    .chat-send {
      background: #28a745;
      color: white;
      border: none;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    .chat-send:hover {
      background: #218838;
    }
    .chat-container.minimized {
      height: 50px;
    }
    .chat-container.minimized .chat-messages,
    .chat-container.minimized .chat-input-container {
      display: none;
    }
    .game-type-selection {
      display: flex;
      gap: 15px;
      margin: 20px 0;
    }
    .game-type-option {
      flex: 1;
      padding: 15px;
      background: rgba(0,0,0,0.1);
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .game-type-option:hover,
    .game-type-option.selected {
      background: rgba(40, 167, 69, 0.3);
    }
    .game-type-option .game-icon {
      font-size: 40px;
      margin-bottom: 10px;
    }
    .error-message {
      color: #ff6b6b;
      margin-top: 5px;
      font-size: 14px;
      text-align: left;
      margin-left: 5%;
    }
    /* Sảnh chờ và danh sách phòng */
    .waiting-room {
      margin: 20px auto;
      max-width: 1200px;
    }
    .room-filters {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
      gap: 10px;
    }
    .filter-btn {
      padding: 8px 15px;
      background: rgba(0,0,0,0.2);
      border: none;
      border-radius: 5px;
      color: white;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .filter-btn.active {
      background: #28a745;
      font-weight: bold;
    }
    .rooms-container {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 15px;
      margin-top: 20px;
    }
    .room-card {
      background: #1e7e34;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      transition: transform 0.2s;
      position: relative;
    }
    .room-card:hover {
      transform: translateY(-5px);
    }
    .room-name {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 10px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .room-type {
      display: inline-block;
      padding: 4px 8px;
      background: rgba(0,0,0,0.2);
      border-radius: 4px;
      font-size: 12px;
      margin-bottom: 10px;
    }
    .room-type.uno {
      background: #dc3545;
    }
    .room-type.chess {
      background: #007bff;
    }
    .room-players {
      font-size: 14px;
      margin-bottom: 10px;
    }
    .room-status {
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 4px;
      display: inline-block;
    }
    .room-status.waiting {
      background: #ffc107;
      color: #000;
    }
    .room-status.playing {
      background: #dc3545;
    }
    .room-actions {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
    }
    .join-btn, .spectate-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.2s;
    }
    .join-btn {
      background: #28a745;
      color: white;
      flex: 2;
      margin-right: 5px;
    }
    .join-btn:hover {
      background: #218838;
    }
    .spectate-btn {
      background: rgba(0,0,0,0.2);
      color: white;
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .spectate-btn:hover {
      background: rgba(0,0,0,0.3);
    }
    .loading-rooms {
      grid-column: 1 / -1;
      text-align: center;
      padding: 20px;
      font-size: 18px;
      color: rgba(255,255,255,0.7);
    }
    .no-rooms {
      grid-column: 1 / -1;
      text-align: center;
      padding: 30px;
      background: rgba(0,0,0,0.1);
      border-radius: 10px;
      font-size: 18px;
    }
    /* Responsive grid */
    @media (max-width: 1200px) {
      .rooms-container {
        grid-template-columns: repeat(4, 1fr);
      }
    }
    @media (max-width: 992px) {
      .rooms-container {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    @media (max-width: 768px) {
      .rooms-container {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    @media (max-width: 576px) {
      .rooms-container {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Modal đăng nhập/đăng ký -->
  <div id="authModal" class="modal" style="display: flex;">
    <div class="modal-content">
      <div class="tab-buttons">
        <button class="tab-button active" data-tab="login">Đăng nhập</button>
        <button class="tab-button" data-tab="register">Đăng ký</button>
        <button class="tab-button" data-tab="guest">Chơi khách</button>
      </div>
      
      <!-- Tab đăng nhập -->
      <div id="login" class="tab-content active">
        <div class="input-group">
          <label for="loginEmail">Email</label>
          <input type="email" id="loginEmail" placeholder="Email của bạn..." />
        </div>
        <div class="input-group">
          <label for="loginPassword">Mật khẩu</label>
          <input type="password" id="loginPassword" placeholder="Mật khẩu..." />
          <div id="loginError" class="error-message"></div>
        </div>
        <button id="loginBtn" class="btn">Đăng nhập</button>
        
        <div class="auth-divider">
          <span>hoặc</span>
        </div>
        
        <div class="auth-options">
          <button id="googleLoginBtn" class="btn btn-google">Đăng nhập với Google</button>
        </div>
      </div>
      
      <!-- Tab đăng ký -->
      <div id="register" class="tab-content">
        <div class="input-group">
          <label for="registerName">Tên hiển thị</label>
          <input type="text" id="registerName" placeholder="Tên của bạn..." />
        </div>
        <div class="input-group">
          <label for="registerEmail">Email</label>
          <input type="email" id="registerEmail" placeholder="Email của bạn..." />
        </div>
        <div class="input-group">
          <label for="registerPassword">Mật khẩu</label>
          <input type="password" id="registerPassword" placeholder="Mật khẩu..." />
          <div id="registerError" class="error-message"></div>
        </div>
        <button id="registerBtn" class="btn">Đăng ký</button>
        
        <div class="auth-divider">
          <span>hoặc</span>
        </div>
        
        <div class="auth-options">
          <button id="googleRegisterBtn" class="btn btn-google">Đăng ký với Google</button>
        </div>
      </div>
      
      <!-- Tab chơi khách -->
      <div id="guest" class="tab-content">
        <div class="input-group">
          <label for="guestName">Tên hiển thị</label>
          <input type="text" id="guestName" placeholder="Tên của bạn..." />
          <div id="guestError" class="error-message"></div>
        </div>
        <p>Lưu ý: Khi chơi với tư cách khách, điểm số của bạn sẽ không được lưu lại.</p>
        <button id="guestLoginBtn" class="btn">Tiếp tục</button>
      </div>
    </div>
  </div>
  
  <!-- Modal tạo phòng -->
  <div id="createRoomModal" class="modal">
    <div class="modal-content">
      <h2>Tạo phòng mới</h2>
      <div class="input-group">
        <label for="roomNameInput">Tên phòng</label>
        <input type="text" id="roomNameInput" placeholder="Nhập tên phòng..." />
      </div>
      
      <h3>Chọn thể loại game</h3>
      <div class="game-type-selection">
        <div class="game-type-option selected" data-game="uno">
          <div class="game-icon">🃏</div>
          <div class="game-title">UNO</div>
          <div class="game-description">4 người chơi</div>
        </div>
        <div class="game-type-option" data-game="chess">
          <div class="game-icon">♟️</div>
          <div class="game-title">Cờ Vua</div>
          <div class="game-description">2 người chơi</div>
        </div>
      </div>
      
      <div class="input-group">
        <div id="createRoomError" class="error-message"></div>
      </div>
      
      <div style="display: flex; gap: 10px; justify-content: center;">
        <button id="confirmCreateRoomBtn" class="btn">Tạo phòng</button>
        <button id="cancelCreateRoomBtn" class="btn btn-danger">Hủy</button>
      </div>
    </div>
  </div>

  <!-- Hồ sơ người dùng -->
  <div id="userProfile" class="user-profile" style="display: none;">
    <div class="user-avatar" id="userAvatar">A</div>
    <div class="user-info">
      <div class="user-name" id="profileUserName">Người dùng</div>
      <div class="user-points" id="profileUserPoints">0 điểm</div>
    </div>
  </div>
  
  <!-- Dropdown hồ sơ -->
  <div id="profileDropdown" class="profile-dropdown">
    <h3>Hồ sơ người dùng</h3>
    <div class="profile-stats">
      <div class="stat-item">
        <span>Tổng điểm:</span>
        <span id="totalPoints">0</span>
      </div>
      <div class="stat-item">
        <span>Trận thắng UNO:</span>
        <span id="unoWins">0</span>
      </div>
      <div class="stat-item">
        <span>Trận thắng Cờ vua:</span>
        <span id="chessWins">0</span>
      </div>
      <div class="stat-item">
        <span>Tổng số trận:</span>
        <span id="totalGames">0</span>
      </div>
    </div>
    <div style="display: flex; gap: 10px; margin-top: 10px;">
      <button id="adminBtn" class="btn btn-primary" style="flex: 1; display: none;">Trang Admin</button>
      <button id="logoutBtn" class="btn btn-danger" style="flex: 1;">Đăng xuất</button>
    </div>
  </div>

  <div class="container">
    <h1>Sảnh chờ trò chơi</h1>
    <div id="waitingRoomSection" class="waiting-room">
      <div class="room-filters">
        <button class="filter-btn active" data-filter="all">Tất cả</button>
        <button class="filter-btn" data-filter="uno">UNO</button>
        <button class="filter-btn" data-filter="chess">Cờ Vua</button>
      </div>
      <div id="roomsContainer" class="rooms-container">
        <div class="loading-rooms">Đang tải danh sách phòng...</div>
      </div>
    </div>
  </div>
  
  <!-- Nút tạo phòng -->
  <div id="createRoomBtn" class="create-room-btn">+</div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <script>
    // Cấu hình Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyBgITWCnQO7pW2-VOAgpKFsK6GN8H037HM",
        authDomain: "masoi-92684.firebaseapp.com",
        databaseURL: "https://masoi-92684-default-rtdb.firebaseio.com",
        projectId: "masoi-92684",
        storageBucket: "masoi-92684.firebasestorage.app",
        messagingSenderId: "1030518945375",
        appId: "1:1030518945375:web:a531a0233c0dcbde120dea",
        measurementId: "G-QNS4GVQ178"
    };
    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();
    
    // Biến lưu trữ thông tin người chơi
    let currentUser = {
      uid: null,
      displayName: '',
      email: '',
      isGuest: true,
      points: 0,
      unoWins: 0,
      chessWins: 0,
      totalGames: 0
    };
    
    // Biến lưu trữ loại game đã chọn khi tạo phòng
    let selectedGameType = 'uno';
    
    // Tham chiếu đến danh sách phòng trong Firebase
    const roomsRef = db.ref('rooms');
    
    // Xử lý chuyển tab trong modal đăng nhập/đăng ký
    document.querySelectorAll('.tab-button').forEach(button => {
      button.addEventListener('click', () => {
        // Xóa class active từ tất cả các tab và nội dung
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        
        // Thêm class active cho tab được chọn
        button.classList.add('active');
        const tabId = button.getAttribute('data-tab');
        document.getElementById(tabId).classList.add('active');
        
        // Xóa thông báo lỗi
        document.querySelectorAll('.error-message').forEach(error => error.textContent = '');
      });
    });
    
    // Xử lý đăng nhập
    document.getElementById('loginBtn').addEventListener('click', () => {
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value;
      const errorElement = document.getElementById('loginError');
      
      if (!email || !password) {
        errorElement.textContent = 'Vui lòng nhập đầy đủ thông tin!';
        return;
      }
      
      auth.signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
          // Đăng nhập thành công
          document.getElementById('authModal').style.display = 'none';
          loadUserProfile(userCredential.user);
        })
        .catch((error) => {
          // Xử lý lỗi đăng nhập
          switch(error.code) {
            case 'auth/user-not-found':
              errorElement.textContent = 'Tài khoản không tồn tại!';
              break;
            case 'auth/wrong-password':
              errorElement.textContent = 'Mật khẩu không chính xác!';
              break;
            default:
              errorElement.textContent = 'Đăng nhập thất bại: ' + error.message;
          }
        });
    });
    
    // Xử lý đăng ký
    document.getElementById('registerBtn').addEventListener('click', () => {
      const name = document.getElementById('registerName').value.trim();
      const email = document.getElementById('registerEmail').value.trim();
      const password = document.getElementById('registerPassword').value;
      const errorElement = document.getElementById('registerError');
      
      if (!name || !email || !password) {
        errorElement.textContent = 'Vui lòng nhập đầy đủ thông tin!';
        return;
      }
      
      if (password.length < 6) {
        errorElement.textContent = 'Mật khẩu phải có ít nhất 6 ký tự!';
        return;
      }
      
      auth.createUserWithEmailAndPassword(email, password)
        .then((userCredential) => {
          // Đăng ký thành công, cập nhật tên hiển thị
          return userCredential.user.updateProfile({
            displayName: name
          }).then(() => {
            // Tạo hồ sơ người dùng trong database
            return db.ref('users/' + userCredential.user.uid).set({
              displayName: name,
              email: email,
              points: 0,
              unoWins: 0,
              chessWins: 0,
              totalGames: 0,
              createdAt: firebase.database.ServerValue.TIMESTAMP
            });
          }).then(() => {
            document.getElementById('authModal').style.display = 'none';
            loadUserProfile(userCredential.user);
          });
        })
        .catch((error) => {
          // Xử lý lỗi đăng ký
          switch(error.code) {
            case 'auth/email-already-in-use':
              errorElement.textContent = 'Email đã được sử dụng!';
              break;
            case 'auth/invalid-email':
              errorElement.textContent = 'Email không hợp lệ!';
              break;
            default:
              errorElement.textContent = 'Đăng ký thất bại: ' + error.message;
          }
        });
    });
    
    // Xử lý đăng nhập với Google
    document.getElementById('googleLoginBtn').addEventListener('click', loginWithGoogle);
    document.getElementById('googleRegisterBtn').addEventListener('click', loginWithGoogle);
    
    function loginWithGoogle() {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider)
        .then((result) => {
          const user = result.user;
          const isNewUser = result.additionalUserInfo.isNewUser;
          
          if (isNewUser) {
            // Tạo hồ sơ người dùng mới trong database
            return db.ref('users/' + user.uid).set({
              displayName: user.displayName,
              email: user.email,
              points: 0,
              unoWins: 0,
              chessWins: 0,
              totalGames: 0,
              createdAt: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
              document.getElementById('authModal').style.display = 'none';
              loadUserProfile(user);
            });
          } else {
            document.getElementById('authModal').style.display = 'none';
            loadUserProfile(user);
          }
        })
        .catch((error) => {
          console.error('Đăng nhập Google thất bại:', error);
        });
    }
    
    // Xử lý đăng nhập khách
    document.getElementById('guestLoginBtn').addEventListener('click', () => {
      const guestName = document.getElementById('guestName').value.trim();
      const errorElement = document.getElementById('guestError');
      
      if (!guestName) {
        errorElement.textContent = 'Vui lòng nhập tên của bạn!';
        return;
      }
      
      // Lưu thông tin người chơi khách
      currentUser = {
        uid: 'guest_' + Date.now(),
        displayName: guestName,
        email: '',
        isGuest: true,
        points: 0,
        unoWins: 0,
        chessWins: 0,
        totalGames: 0
      };
      
      // Lưu thông tin vào localStorage cho cả guestUser và userInfo
      localStorage.setItem('guestUser', JSON.stringify(currentUser));
      localStorage.setItem('userInfo', JSON.stringify({
        uid: currentUser.uid,
        displayName: currentUser.displayName,
        isGuest: true,
        points: 0
      }));
      
      // Đóng modal và hiển thị thông tin người dùng
      document.getElementById('authModal').style.display = 'none';
      updateUserProfileUI();
      
      // Tải danh sách phòng
      loadRooms();
    });
    
    // Xử lý đăng xuất
    document.getElementById('logoutBtn').addEventListener('click', () => {
      auth.signOut().then(() => {
        // Xóa thông tin người dùng khách nếu có
        localStorage.removeItem('guestUser');
        
        // Đặt lại thông tin người dùng
        currentUser = {
          uid: null,
          displayName: '',
          email: '',
          isGuest: true,
          points: 0,
          unoWins: 0,
          chessWins: 0,
          totalGames: 0
        };
        
        // Ẩn dropdown hồ sơ
        document.getElementById('profileDropdown').classList.remove('show');
        
        // Ẩn thông tin người dùng
        document.getElementById('userProfile').style.display = 'none';
        
        // Hiển thị modal đăng nhập
        document.getElementById('authModal').style.display = 'flex';
      }).catch((error) => {
        console.error('Đăng xuất thất bại:', error);
      });
    });
    
    // Xử lý nút admin
    document.getElementById('adminBtn').addEventListener('click', () => {
      // Kiểm tra quyền admin trước khi chuyển hướng
      const userInfo = JSON.parse(localStorage.getItem('userInfo')) || {};
      const adminEmails = ['micovan108@gmail.com', 'admin@example.com'];
      
      if (userInfo.email && adminEmails.includes(userInfo.email)) {
        window.location.href = 'admin.html';
      } else {
        alert('Bạn không có quyền truy cập trang quản trị!');
      }
    });
    
    // Xử lý hiển thị/ẩn dropdown hồ sơ
    document.getElementById('userProfile').addEventListener('click', () => {
      document.getElementById('profileDropdown').classList.toggle('show');
    });
    
    // Đóng dropdown khi click ra ngoài
    window.addEventListener('click', (event) => {
      const dropdown = document.getElementById('profileDropdown');
      const profile = document.getElementById('userProfile');
      
      if (dropdown.classList.contains('show') && 
          !profile.contains(event.target) && 
          !dropdown.contains(event.target)) {
        dropdown.classList.remove('show');
      }
    });
    
    // Xử lý chọn loại game trong modal tạo phòng
    document.querySelectorAll('.game-type-option').forEach(option => {
      option.addEventListener('click', () => {
        // Xóa class selected từ tất cả các option
        document.querySelectorAll('.game-type-option').forEach(opt => opt.classList.remove('selected'));
        
        // Thêm class selected cho option được chọn
        option.classList.add('selected');
        
        // Lưu loại game đã chọn
        selectedGameType = option.getAttribute('data-game');
      });
    });
    
    // Xử lý hiển thị modal tạo phòng
    document.getElementById('createRoomBtn').addEventListener('click', () => {
      if (!currentUser.uid) {
        alert('Vui lòng đăng nhập trước khi tạo phòng!');
        return;
      }
      
      document.getElementById('createRoomModal').style.display = 'flex';
    });
    
    // Xử lý đóng modal tạo phòng
    document.getElementById('cancelCreateRoomBtn').addEventListener('click', () => {
      document.getElementById('createRoomModal').style.display = 'none';
      document.getElementById('roomNameInput').value = '';
      document.getElementById('createRoomError').textContent = '';
    });
    
    // Xử lý tạo phòng
    document.getElementById('confirmCreateRoomBtn').addEventListener('click', async () => {

    const roomName = document.getElementById('roomNameInput').value.trim();
      const errorElement = document.getElementById('createRoomError');
      
      if (!roomName) {
        errorElement.textContent = 'Vui lòng nhập tên phòng!';
        return;
      }
      
      if (!currentUser.uid) {
        errorElement.textContent = 'Vui lòng đăng nhập trước khi tạo phòng!';
        return;
      }
      
      // Kiểm tra xem tên phòng đã tồn tại chưa
      roomsRef.orderByChild('name').equalTo(roomName).once('value', snapshot => {
        if (snapshot.exists()) {
          errorElement.textContent = 'Tên phòng đã tồn tại, vui lòng chọn tên khác!';
          return;
        }
        
        // Tạo phòng mới
  const playerName = localStorage.getItem('playerName') || 'Người dùng';

  const newRoomRef = roomsRef.push();
  const roomData = {
    name: roomName,
    gameType: selectedGameType,
    createdAt: firebase.database.ServerValue.TIMESTAMP,
    status: 'waiting',
    host: currentUser.uid, // Sử dụng uid của người dùng hiện tại thay vì displayName để đồng nhất với UNO
    players: {}
  };
  
  // Thêm người tạo phòng vào danh sách người chơi
  roomData.players[currentUser.uid] = {
    displayName: currentUser.displayName,
    points: currentUser.points,
    isHost: true,
    joinedAt: firebase.database.ServerValue.TIMESTAMP
  };


        
        // Lưu thông tin phòng vào database
        newRoomRef.set(roomData, error => {
          if (error) {
            errorElement.textContent = 'Có lỗi xảy ra khi tạo phòng: ' + error.message;
            return;
          }
          
          // Đóng modal tạo phòng
          document.getElementById('createRoomModal').style.display = 'none';
          document.getElementById('roomNameInput').value = '';
          
          // Lưu ID phòng vào localStorage
          localStorage.setItem('selectedRoomId', newRoomRef.key);
          
          // Chuyển hướng đến trang game tương ứng
          if (selectedGameType === 'uno') {
            window.location.href = 'uno.html';
          } else if (selectedGameType === 'chess') {
            window.location.href = 'covua.html';
          }
        });
      });
    });
    
    
    // Hàm tải danh sách phòng từ Firebase và hiển thị trong sảnh chờ
    function loadRooms() {
      const roomsContainer = document.getElementById('roomsContainer');
      roomsContainer.innerHTML = '<div class="loading-rooms">Đang tải danh sách phòng...</div>';
      
      // Lắng nghe sự thay đổi của danh sách phòng
      roomsRef.on('value', snapshot => {
        if (!snapshot.exists()) {
          roomsContainer.innerHTML = '<div class="no-rooms">Chưa có phòng nào được tạo. Hãy tạo phòng mới!</div>';
          return;
        }
        
        // Xóa nội dung cũ
        roomsContainer.innerHTML = '';
        
        // Lấy danh sách phòng
        const rooms = snapshot.val();
        const roomIds = Object.keys(rooms);
        
        // Lọc phòng theo bộ lọc hiện tại
        const currentFilter = document.querySelector('.filter-btn.active').getAttribute('data-filter');
        
        // Kiểm tra xem có phòng nào không
        let visibleRooms = 0;
        
        // Hiển thị danh sách phòng
        roomIds.forEach(roomId => {
          const room = rooms[roomId];
          
          // Kiểm tra bộ lọc
          if (currentFilter !== 'all' && room.gameType !== currentFilter) {
            return;
          }
          
          visibleRooms++;
          
          // Tạo phần tử hiển thị phòng
          const roomCard = document.createElement('div');
          roomCard.className = 'room-card';
          
          // Đếm số người chơi trong phòng
          const playerCount = room.players ? Object.keys(room.players).length : 0;
          
          // Xác định trạng thái phòng
          const isPlaying = room.status === 'playing';
          const statusClass = isPlaying ? 'playing' : 'waiting';
          const statusText = isPlaying ? 'Đang chơi' : 'Đang chờ';
          
          // Xác định loại game
          const gameTypeText = room.gameType === 'uno' ? 'UNO' : 'Cờ Vua';
          const gameTypeClass = room.gameType;
          
          // Xác định số người chơi tối đa
          const maxPlayers = room.gameType === 'uno' ? 4 : 2;
          
          // Tạo nội dung cho phòng
          roomCard.innerHTML = `
            <div class="room-name">${room.name}</div>
            <div class="room-type ${gameTypeClass}">${gameTypeText}</div>
            <div class="room-players">${playerCount}/${maxPlayers} người chơi</div>
            <div class="room-status ${statusClass}">${statusText}</div>
            <div class="room-actions">
              ${!isPlaying ? 
                `<button class="join-btn" data-room-id="${roomId}" data-game-type="${room.gameType}">Tham gia</button>` : 
                `<button class="join-btn" disabled>Đang chơi</button>`
              }
              <button class="spectate-btn" data-room-id="${roomId}" data-game-type="${room.gameType}" title="Xem phòng">
                <span>👁️</span>
              </button>
            </div>
          `;
          
          // Thêm phòng vào container
          roomsContainer.appendChild(roomCard);
        });
        
        // Hiển thị thông báo nếu không có phòng nào
        if (visibleRooms === 0) {
          roomsContainer.innerHTML = `<div class="no-rooms">Không tìm thấy phòng ${currentFilter !== 'all' ? currentFilter : ''} nào. Hãy tạo phòng mới!</div>`;
        }
        
        // Thêm sự kiện cho các nút tham gia và xem phòng
        addRoomButtonEvents();
      });
    }
    
    // Thêm sự kiện cho các nút trong danh sách phòng
    function addRoomButtonEvents() {
      // Sự kiện cho nút tham gia phòng
      document.querySelectorAll('.join-btn').forEach(button => {
        if (button.disabled) return;
        
        button.addEventListener('click', () => {
          if (!currentUser.uid) {
            alert('Vui lòng đăng nhập trước khi tham gia phòng!');
            return;
          }
          
          const roomId = button.getAttribute('data-room-id');
          const gameType = button.getAttribute('data-game-type');
          
          // Lưu ID phòng vào localStorage
          localStorage.setItem('selectedRoomId', roomId);
          
          // Chuyển hướng đến trang game tương ứng
          if (gameType === 'uno') {
            window.location.href = 'uno.html';
          } else if (gameType === 'chess') {
            window.location.href = 'covua.html';
          }
        });
      });
      
      // Sự kiện cho nút xem phòng
      document.querySelectorAll('.spectate-btn').forEach(button => {
        button.addEventListener('click', () => {
          if (!currentUser.uid) {
            alert('Vui lòng đăng nhập trước khi xem phòng!');
            return;
          }
          
          const roomId = button.getAttribute('data-room-id');
          const gameType = button.getAttribute('data-game-type');
          
          // Lưu ID phòng và trạng thái người xem vào localStorage
          localStorage.setItem('selectedRoomId', roomId);
          localStorage.setItem('isSpectator', 'true');
          
          // Chuyển hướng đến trang game tương ứng
          if (gameType === 'uno') {
            window.location.href = 'uno.html';
          } else if (gameType === 'chess') {
            window.location.href = 'covua.html';
          }
        });
      });
    }
    
    // Xử lý bộ lọc phòng
    document.querySelectorAll('.filter-btn').forEach(button => {
      button.addEventListener('click', () => {
        // Xóa class active từ tất cả các nút
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        
        // Thêm class active cho nút được chọn
        button.classList.add('active');
        
        // Tải lại danh sách phòng với bộ lọc mới
        loadRooms();
      });
    });
    
    // Hàm tải thông tin hồ sơ người dùng
    function loadUserProfile(user) {
      if (!user) return;
      
      // Lấy thông tin người dùng từ database
      db.ref('users/' + user.uid).once('value', snapshot => {
        if (snapshot.exists()) {
          // Cập nhật thông tin người dùng từ database
          const userData = snapshot.val();
          currentUser = {
            uid: user.uid,
            displayName: userData.displayName || user.displayName,
            email: userData.email || user.email,
            isGuest: false,
            points: userData.points || 0,
            unoWins: userData.unoWins || 0,
            chessWins: userData.chessWins || 0,
            totalGames: userData.totalGames || 0
          };
        } else {
          // Tạo hồ sơ người dùng mới nếu chưa tồn tại
          currentUser = {
            uid: user.uid,
            displayName: user.displayName,
            email: user.email,
            isGuest: false,
            points: 0,
            unoWins: 0,
            chessWins: 0,
            totalGames: 0
          };
          
          db.ref('users/' + user.uid).set({
            displayName: user.displayName,
            email: user.email,
            points: 0,
            unoWins: 0,
            chessWins: 0,
            totalGames: 0,
            createdAt: firebase.database.ServerValue.TIMESTAMP
          });
        }
        
        // Lưu thông tin người dùng vào localStorage để các trang game có thể sử dụng
        localStorage.setItem('userInfo', JSON.stringify({
          uid: currentUser.uid,
          displayName: currentUser.displayName,
          email: currentUser.email,
          isGuest: currentUser.isGuest,
          points: currentUser.points,
          photoURL: user.photoURL || null
        }));
        
        // Cập nhật giao diện người dùng
        updateUserProfileUI();
        
        // Tải danh sách phòng
        loadRooms();
      });
    }
    
    // Hàm cập nhật giao diện hồ sơ người dùng
    function updateUserProfileUI() {
      if (currentUser.uid) {
        // Hiển thị thông tin người dùng
        document.getElementById('userProfile').style.display = 'flex';
        document.getElementById('profileUserName').textContent = currentUser.displayName;
        document.getElementById('profileUserPoints').textContent = currentUser.points + ' điểm';
        
        // Cập nhật avatar
        const avatarElement = document.getElementById('userAvatar');
        avatarElement.textContent = currentUser.displayName.charAt(0).toUpperCase();
        
        // Cập nhật thông tin trong dropdown hồ sơ
        document.getElementById('totalPoints').textContent = currentUser.points;
        document.getElementById('unoWins').textContent = currentUser.unoWins;
        document.getElementById('chessWins').textContent = currentUser.chessWins;
        document.getElementById('totalGames').textContent = currentUser.totalGames;
        
        // Hiển thị nút admin chỉ cho tài khoản admin
        const adminBtn = document.getElementById('adminBtn');
        const adminEmails = ['micovan108@gmail.com', 'admin@example.com'];
        if (currentUser.email && adminEmails.includes(currentUser.email)) {
          adminBtn.style.display = 'block';
        } else {
          adminBtn.style.display = 'none';
        }
      } else {
        // Ẩn thông tin người dùng nếu chưa đăng nhập
        document.getElementById('userProfile').style.display = 'none';
      }
    }
    
    // Kiểm tra trạng thái đăng nhập khi trang web được tải
    window.addEventListener('DOMContentLoaded', () => {
      // Kiểm tra xem có người dùng đã đăng nhập không
      auth.onAuthStateChanged(user => {
        if (user) {
          // Người dùng đã đăng nhập
          document.getElementById('authModal').style.display = 'none';
          loadUserProfile(user);
        } else {
          // Kiểm tra xem có thông tin người dùng khách không
          const guestUserData = localStorage.getItem('guestUser');
          if (guestUserData) {
            currentUser = JSON.parse(guestUserData);
            document.getElementById('authModal').style.display = 'none';
            updateUserProfileUI();
            
            // Tải danh sách phòng
            loadRooms();
          }
        }
      });
    });
    
    // Khởi tạo khung chat
    let chatContainer;
    let chatMessages;
    let chatInput;
    let chatMessagesRef;
    let chatCleanupInterval;
    
    function initializeChat() {
      if (!currentUser.uid) return;
      
      // Tạo khung chat nếu chưa tồn tại
      if (!document.querySelector('.chat-container')) {
        // Tạo container cho khung chat
        chatContainer = document.createElement('div');
        chatContainer.className = 'chat-container';
        chatContainer.innerHTML = `
          <div class="chat-header">
            <div class="chat-title">Chat Công Cộng</div>
            <button class="chat-toggle">−</button>
          </div>
          <div class="chat-messages"></div>
          <div class="chat-input-container">
            <input type="text" class="chat-input" placeholder="Nhập tin nhắn...">
            <button class="chat-send">➤</button>
          </div>
        `;
        document.body.appendChild(chatContainer);
        
        // Lấy các phần tử cần thiết
        chatMessages = chatContainer.querySelector('.chat-messages');
        chatInput = chatContainer.querySelector('.chat-input');
        const chatToggle = chatContainer.querySelector('.chat-toggle');
        const chatSend = chatContainer.querySelector('.chat-send');
        
        // Xử lý sự kiện thu gọn/mở rộng khung chat
        chatToggle.addEventListener('click', () => {
          chatContainer.classList.toggle('minimized');
          chatToggle.textContent = chatContainer.classList.contains('minimized') ? '+' : '−';
        });
        
        // Xử lý sự kiện gửi tin nhắn
        function sendMessage() {
          const message = chatInput.value.trim();
          if (message && currentUser.uid) {
            // Tạo tin nhắn mới
            const newMessage = {
              text: message,
              sender: currentUser.uid,
              senderName: currentUser.displayName,
              timestamp: firebase.database.ServerValue.TIMESTAMP
            };
            
            // Lưu tin nhắn vào Firebase
            chatMessagesRef.push(newMessage);
            
            // Xóa nội dung input
            chatInput.value = '';
          }
        }
        
        // Xử lý sự kiện khi nhấn nút gửi
        chatSend.addEventListener('click', sendMessage);
        
        // Xử lý sự kiện khi nhấn Enter
        chatInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            sendMessage();
          }
        });
      }
      
      // Kết nối với Firebase để lấy tin nhắn
      chatMessagesRef = db.ref('chat/messages');
      
      // Lắng nghe sự kiện khi có tin nhắn mới
      chatMessagesRef.on('child_added', (snapshot) => {
        const message = snapshot.val();
        if (!message) return;
        
        // Tạo phần tử hiển thị tin nhắn
        const messageElement = document.createElement('div');
        messageElement.className = `chat-message ${message.sender === currentUser.uid ? 'sent' : 'received'}`;
        
        // Định dạng thời gian
        const messageTime = new Date(message.timestamp);
        const timeString = messageTime.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
        
        // Thêm nội dung tin nhắn
        messageElement.innerHTML = `
          ${message.sender !== currentUser.uid ? `<div class="message-sender">${message.senderName}</div>` : ''}
          <div class="message-text">${message.text}</div>
          <div class="message-time">${timeString}</div>
        `;
        
        // Thêm tin nhắn vào khung chat
        chatMessages.appendChild(messageElement);
        
        // Cuộn xuống tin nhắn mới nhất
        chatMessages.scrollTop = chatMessages.scrollHeight;
      });
      
      // Thiết lập interval để xóa tin nhắn cũ sau mỗi 1 giờ
      if (!chatCleanupInterval) {
        chatCleanupInterval = setInterval(cleanupOldMessages, 60 * 60 * 1000); // 1 giờ
      }
    }
    
    // Hàm xóa tin nhắn cũ
    function cleanupOldMessages() {
      if (!chatMessagesRef) return;
      
      // Lấy thời gian hiện tại
      const now = new Date().getTime();
      // Thời gian 1 giờ trước
      const oneHourAgo = now - (60 * 60 * 1000);
      
      // Truy vấn tin nhắn cũ hơn 1 giờ
      chatMessagesRef.orderByChild('timestamp').endAt(oneHourAgo).once('value', (snapshot) => {
        // Xóa từng tin nhắn cũ
        snapshot.forEach((childSnapshot) => {
          chatMessagesRef.child(childSnapshot.key).remove();
        });
      });
    }
    
    // Khởi tạo chat khi người dùng đã đăng nhập
    auth.onAuthStateChanged(user => {
      if (user) {
        // Khởi tạo chat sau khi đã tải thông tin người dùng
        setTimeout(initializeChat, 1000);
      }
    });
  </script>
</body>
</html>