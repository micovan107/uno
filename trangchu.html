<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Tr√≤ ch∆°i Online v·ªõi Firebase</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #146c43;
      color: #fff;
      text-align: center;
      margin: 0; padding: 20px;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    .game-selection {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin-top: 50px;
    }
    .game-card {
      background: #1e7e34;
      padding: 20px;
      border-radius: 10px;
      width: 300px;
      box-shadow: 0 0 15px rgba(0,0,0,0.5);
      transition: transform 0.3s;
      cursor: pointer;
    }
    .game-card:hover {
      transform: translateY(-10px);
    }
    .game-icon {
      font-size: 60px;
      margin-bottom: 20px;
    }
    .game-title {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 15px;
    }
    .game-description {
      font-size: 16px;
      margin-bottom: 20px;
    }
    .player-count {
      background: rgba(255,255,255,0.1);
      padding: 8px;
      border-radius: 5px;
      display: inline-block;
      margin-bottom: 15px;
    }
    .btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .btn:hover {
      background: #218838;
    }
    .btn-primary {
      background: #007bff;
    }
    .btn-primary:hover {
      background: #0069d9;
    }
    .btn-danger {
      background: #dc3545;
    }
    .btn-danger:hover {
      background: #c82333;
    }
    .btn-google {
      background: #db4437;
    }
    .btn-google:hover {
      background: #c53929;
    }
    /* Modal nh·∫≠p t√™n */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 100;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: #1e7e34;
      padding: 20px;
      border-radius: 10px;
      width: 350px;
      text-align: center;
    }
    .input-group {
      margin-bottom: 15px;
    }
    .input-group input {
      padding: 10px;
      width: 90%;
      border-radius: 5px;
      border: none;
      font-size: 16px;
    }
    .input-group label {
      display: block;
      text-align: left;
      margin-left: 5%;
      margin-bottom: 5px;
      font-weight: bold;
    }
    .auth-options {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin: 15px 0;
    }
    .auth-divider {
      display: flex;
      align-items: center;
      margin: 15px 0;
    }
    .auth-divider::before,
    .auth-divider::after {
      content: "";
      flex: 1;
      border-bottom: 1px solid rgba(255,255,255,0.3);
    }
    .auth-divider span {
      padding: 0 10px;
      color: rgba(255,255,255,0.7);
    }
    .tab-buttons {
      display: flex;
      margin-bottom: 20px;
    }
    .tab-button {
      flex: 1;
      padding: 10px;
      background: rgba(0,0,0,0.2);
      border: none;
      color: white;
      cursor: pointer;
    }
    .tab-button.active {
      background: #28a745;
      font-weight: bold;
    }
    .tab-button:first-child {
      border-top-left-radius: 5px;
      border-bottom-left-radius: 5px;
    }
    .tab-button:last-child {
      border-top-right-radius: 5px;
      border-bottom-right-radius: 5px;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .user-profile {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(0,0,0,0.2);
      padding: 10px 15px;
      border-radius: 50px;
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
    }
    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #28a745;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: bold;
    }
    .user-info {
      text-align: left;
    }
    .user-name {
      font-weight: bold;
      font-size: 16px;
    }
    .user-points {
      font-size: 14px;
      color: rgba(255,255,255,0.8);
    }
    .profile-dropdown {
      position: absolute;
      top: 70px;
      right: 20px;
      background: #1e7e34;
      border-radius: 10px;
      padding: 15px;
      width: 250px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      display: none;
      z-index: 50;
    }
    .profile-dropdown.show {
      display: block;
    }
    .profile-stats {
      margin: 15px 0;
      padding: 10px;
      background: rgba(0,0,0,0.1);
      border-radius: 5px;
    }
    .stat-item {
      display: flex;
      justify-content: space-between;
      margin: 5px 0;
    }
    .create-room-btn {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: #28a745;
      color: white;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      transition: transform 0.2s, background-color 0.2s;
    }
    .create-room-btn:hover {
      transform: scale(1.1);
      background: #218838;
    }
    
    /* CSS cho khung chat */
    .chat-container {
      position: fixed;
      bottom: 30px;
      left: 30px;
      width: 300px;
      height: 400px;
      background: rgba(0, 0, 0, 0.7);
      border-radius: 10px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
      z-index: 100;
      transition: all 0.3s ease;
    }
    .chat-header {
      background: rgba(30, 126, 52, 0.8);
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }
    .chat-title {
      font-weight: bold;
      font-size: 16px;
    }
    .chat-toggle {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 18px;
    }
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .chat-message {
      padding: 8px 12px;
      border-radius: 15px;
      max-width: 80%;
      word-break: break-word;
    }
    .chat-message.sent {
      align-self: flex-end;
      background: #28a745;
    }
    .chat-message.received {
      align-self: flex-start;
      background: #343a40;
    }
    .message-sender {
      font-size: 12px;
      font-weight: bold;
      margin-bottom: 3px;
    }
    .message-time {
      font-size: 10px;
      opacity: 0.7;
      text-align: right;
      margin-top: 2px;
    }
    .chat-input-container {
      display: flex;
      padding: 10px;
      background: rgba(30, 126, 52, 0.8);
    }
    .chat-input {
      flex: 1;
      padding: 8px 12px;
      border: none;
      border-radius: 20px;
      margin-right: 8px;
      background: rgba(255, 255, 255, 0.9);
    }
    .chat-send {
      background: #28a745;
      color: white;
      border: none;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    .chat-send:hover {
      background: #218838;
    }
    .chat-container.minimized {
      height: 50px;
    }
    .chat-container.minimized .chat-messages,
    .chat-container.minimized .chat-input-container {
      display: none;
    }
    .game-type-selection {
      display: flex;
      gap: 15px;
      margin: 20px 0;
    }
    .game-type-option {
      flex: 1;
      padding: 15px;
      background: rgba(0,0,0,0.1);
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .game-type-option:hover,
    .game-type-option.selected {
      background: rgba(40, 167, 69, 0.3);
    }
    .game-type-option .game-icon {
      font-size: 40px;
      margin-bottom: 10px;
    }
    .error-message {
      color: #ff6b6b;
      margin-top: 5px;
      font-size: 14px;
      text-align: left;
      margin-left: 5%;
    }
    /* S·∫£nh ch·ªù v√† danh s√°ch ph√≤ng */
    .waiting-room {
      margin: 20px auto;
      max-width: 1200px;
    }
    .room-filters {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
      gap: 10px;
    }
    .filter-btn {
      padding: 8px 15px;
      background: rgba(0,0,0,0.2);
      border: none;
      border-radius: 5px;
      color: white;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .filter-btn.active {
      background: #28a745;
      font-weight: bold;
    }
    .rooms-container {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 15px;
      margin-top: 20px;
    }
    .room-card {
      background: #1e7e34;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      transition: transform 0.2s;
      position: relative;
    }
    .room-card:hover {
      transform: translateY(-5px);
    }
    .room-name {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 10px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .room-type {
      display: inline-block;
      padding: 4px 8px;
      background: rgba(0,0,0,0.2);
      border-radius: 4px;
      font-size: 12px;
      margin-bottom: 10px;
    }
    .room-type.uno {
      background: #dc3545;
    }
    .room-type.chess {
      background: #007bff;
    }
    .room-players {
      font-size: 14px;
      margin-bottom: 10px;
    }
    .room-status {
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 4px;
      display: inline-block;
    }
    .room-status.waiting {
      background: #ffc107;
      color: #000;
    }
    .room-status.playing {
      background: #dc3545;
    }
    .room-actions {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
    }
    .join-btn, .spectate-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.2s;
    }
    .join-btn {
      background: #28a745;
      color: white;
      flex: 2;
      margin-right: 5px;
    }
    .join-btn:hover {
      background: #218838;
    }
    .spectate-btn {
      background: rgba(0,0,0,0.2);
      color: white;
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .spectate-btn:hover {
      background: rgba(0,0,0,0.3);
    }
    .loading-rooms {
      grid-column: 1 / -1;
      text-align: center;
      padding: 20px;
      font-size: 18px;
      color: rgba(255,255,255,0.7);
    }
    .no-rooms {
      grid-column: 1 / -1;
      text-align: center;
      padding: 30px;
      background: rgba(0,0,0,0.1);
      border-radius: 10px;
      font-size: 18px;
    }
    /* Responsive grid */
    @media (max-width: 1200px) {
      .rooms-container {
        grid-template-columns: repeat(4, 1fr);
      }
    }
    @media (max-width: 992px) {
      .rooms-container {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    @media (max-width: 768px) {
      .rooms-container {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    @media (max-width: 576px) {
      .rooms-container {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Modal ƒëƒÉng nh·∫≠p/ƒëƒÉng k√Ω -->
  <div id="authModal" class="modal" style="display: flex;">
    <div class="modal-content">
      <div class="tab-buttons">
        <button class="tab-button active" data-tab="login">ƒêƒÉng nh·∫≠p</button>
        <button class="tab-button" data-tab="register">ƒêƒÉng k√Ω</button>
        <button class="tab-button" data-tab="guest">Ch∆°i kh√°ch</button>
      </div>
      
      <!-- Tab ƒëƒÉng nh·∫≠p -->
      <div id="login" class="tab-content active">
        <div class="input-group">
          <label for="loginEmail">Email</label>
          <input type="email" id="loginEmail" placeholder="Email c·ªßa b·∫°n..." />
        </div>
        <div class="input-group">
          <label for="loginPassword">M·∫≠t kh·∫©u</label>
          <input type="password" id="loginPassword" placeholder="M·∫≠t kh·∫©u..." />
          <div id="loginError" class="error-message"></div>
        </div>
        <button id="loginBtn" class="btn">ƒêƒÉng nh·∫≠p</button>
        
        <div class="auth-divider">
          <span>ho·∫∑c</span>
        </div>
        
        <div class="auth-options">
          <button id="googleLoginBtn" class="btn btn-google">ƒêƒÉng nh·∫≠p v·ªõi Google</button>
        </div>
      </div>
      
      <!-- Tab ƒëƒÉng k√Ω -->
      <div id="register" class="tab-content">
        <div class="input-group">
          <label for="registerName">T√™n hi·ªÉn th·ªã</label>
          <input type="text" id="registerName" placeholder="T√™n c·ªßa b·∫°n..." />
        </div>
        <div class="input-group">
          <label for="registerEmail">Email</label>
          <input type="email" id="registerEmail" placeholder="Email c·ªßa b·∫°n..." />
        </div>
        <div class="input-group">
          <label for="registerPassword">M·∫≠t kh·∫©u</label>
          <input type="password" id="registerPassword" placeholder="M·∫≠t kh·∫©u..." />
          <div id="registerError" class="error-message"></div>
        </div>
        <button id="registerBtn" class="btn">ƒêƒÉng k√Ω</button>
        
        <div class="auth-divider">
          <span>ho·∫∑c</span>
        </div>
        
        <div class="auth-options">
          <button id="googleRegisterBtn" class="btn btn-google">ƒêƒÉng k√Ω v·ªõi Google</button>
        </div>
      </div>
      
      <!-- Tab ch∆°i kh√°ch -->
      <div id="guest" class="tab-content">
        <div class="input-group">
          <label for="guestName">T√™n hi·ªÉn th·ªã</label>
          <input type="text" id="guestName" placeholder="T√™n c·ªßa b·∫°n..." />
          <div id="guestError" class="error-message"></div>
        </div>
        <p>L∆∞u √Ω: Khi ch∆°i v·ªõi t∆∞ c√°ch kh√°ch, ƒëi·ªÉm s·ªë c·ªßa b·∫°n s·∫Ω kh√¥ng ƒë∆∞·ª£c l∆∞u l·∫°i.</p>
        <button id="guestLoginBtn" class="btn">Ti·∫øp t·ª•c</button>
      </div>
    </div>
  </div>
  
  <!-- Modal t·∫°o ph√≤ng -->
  <div id="createRoomModal" class="modal">
    <div class="modal-content">
      <h2>T·∫°o ph√≤ng m·ªõi</h2>
      <div class="input-group">
        <label for="roomNameInput">T√™n ph√≤ng</label>
        <input type="text" id="roomNameInput" placeholder="Nh·∫≠p t√™n ph√≤ng..." />
      </div>
      
      <h3>Ch·ªçn th·ªÉ lo·∫°i game</h3>
      <div class="game-type-selection">
        <div class="game-type-option selected" data-game="uno">
          <div class="game-icon">üÉè</div>
          <div class="game-title">UNO</div>
          <div class="game-description">4 ng∆∞·ªùi ch∆°i</div>
        </div>
        <div class="game-type-option" data-game="chess">
          <div class="game-icon">‚ôüÔ∏è</div>
          <div class="game-title">C·ªù Vua</div>
          <div class="game-description">2 ng∆∞·ªùi ch∆°i</div>
        </div>
      </div>
      
      <div class="input-group">
        <div id="createRoomError" class="error-message"></div>
      </div>
      
      <div style="display: flex; gap: 10px; justify-content: center;">
        <button id="confirmCreateRoomBtn" class="btn">T·∫°o ph√≤ng</button>
        <button id="cancelCreateRoomBtn" class="btn btn-danger">H·ªßy</button>
      </div>
    </div>
  </div>

  <!-- H·ªì s∆° ng∆∞·ªùi d√πng -->
  <div id="userProfile" class="user-profile" style="display: none;">
    <div class="user-avatar" id="userAvatar">A</div>
    <div class="user-info">
      <div class="user-name" id="profileUserName">Ng∆∞·ªùi d√πng</div>
      <div class="user-points" id="profileUserPoints">0 ƒëi·ªÉm</div>
    </div>
  </div>
  
  <!-- Dropdown h·ªì s∆° -->
  <div id="profileDropdown" class="profile-dropdown">
    <h3>H·ªì s∆° ng∆∞·ªùi d√πng</h3>
    <div class="profile-stats">
      <div class="stat-item">
        <span>T·ªïng ƒëi·ªÉm:</span>
        <span id="totalPoints">0</span>
      </div>
      <div class="stat-item">
        <span>Tr·∫≠n th·∫Øng UNO:</span>
        <span id="unoWins">0</span>
      </div>
      <div class="stat-item">
        <span>Tr·∫≠n th·∫Øng C·ªù vua:</span>
        <span id="chessWins">0</span>
      </div>
      <div class="stat-item">
        <span>T·ªïng s·ªë tr·∫≠n:</span>
        <span id="totalGames">0</span>
      </div>
    </div>
    <div style="display: flex; gap: 10px; margin-top: 10px;">
      <button id="adminBtn" class="btn btn-primary" style="flex: 1; display: none;">Trang Admin</button>
      <button id="logoutBtn" class="btn btn-danger" style="flex: 1;">ƒêƒÉng xu·∫•t</button>
    </div>
  </div>

  <div class="container">
    <h1>S·∫£nh ch·ªù tr√≤ ch∆°i</h1>
    <div id="waitingRoomSection" class="waiting-room">
      <div class="room-filters">
        <button class="filter-btn active" data-filter="all">T·∫•t c·∫£</button>
        <button class="filter-btn" data-filter="uno">UNO</button>
        <button class="filter-btn" data-filter="chess">C·ªù Vua</button>
      </div>
      <div id="roomsContainer" class="rooms-container">
        <div class="loading-rooms">ƒêang t·∫£i danh s√°ch ph√≤ng...</div>
      </div>
    </div>
  </div>
  
  <!-- N√∫t t·∫°o ph√≤ng -->
  <div id="createRoomBtn" class="create-room-btn">+</div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <script>
    // C·∫•u h√¨nh Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyBgITWCnQO7pW2-VOAgpKFsK6GN8H037HM",
        authDomain: "masoi-92684.firebaseapp.com",
        databaseURL: "https://masoi-92684-default-rtdb.firebaseio.com",
        projectId: "masoi-92684",
        storageBucket: "masoi-92684.firebasestorage.app",
        messagingSenderId: "1030518945375",
        appId: "1:1030518945375:web:a531a0233c0dcbde120dea",
        measurementId: "G-QNS4GVQ178"
    };
    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();
    
    // Bi·∫øn l∆∞u tr·ªØ th√¥ng tin ng∆∞·ªùi ch∆°i
    let currentUser = {
      uid: null,
      displayName: '',
      email: '',
      isGuest: true,
      points: 0,
      unoWins: 0,
      chessWins: 0,
      totalGames: 0
    };
    
    // Bi·∫øn l∆∞u tr·ªØ lo·∫°i game ƒë√£ ch·ªçn khi t·∫°o ph√≤ng
    let selectedGameType = 'uno';
    
    // Tham chi·∫øu ƒë·∫øn danh s√°ch ph√≤ng trong Firebase
    const roomsRef = db.ref('rooms');
    
    // X·ª≠ l√Ω chuy·ªÉn tab trong modal ƒëƒÉng nh·∫≠p/ƒëƒÉng k√Ω
    document.querySelectorAll('.tab-button').forEach(button => {
      button.addEventListener('click', () => {
        // X√≥a class active t·ª´ t·∫•t c·∫£ c√°c tab v√† n·ªôi dung
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        
        // Th√™m class active cho tab ƒë∆∞·ª£c ch·ªçn
        button.classList.add('active');
        const tabId = button.getAttribute('data-tab');
        document.getElementById(tabId).classList.add('active');
        
        // X√≥a th√¥ng b√°o l·ªói
        document.querySelectorAll('.error-message').forEach(error => error.textContent = '');
      });
    });
    
    // X·ª≠ l√Ω ƒëƒÉng nh·∫≠p
    document.getElementById('loginBtn').addEventListener('click', () => {
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value;
      const errorElement = document.getElementById('loginError');
      
      if (!email || !password) {
        errorElement.textContent = 'Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!';
        return;
      }
      
      auth.signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
          // ƒêƒÉng nh·∫≠p th√†nh c√¥ng
          document.getElementById('authModal').style.display = 'none';
          loadUserProfile(userCredential.user);
        })
        .catch((error) => {
          // X·ª≠ l√Ω l·ªói ƒëƒÉng nh·∫≠p
          switch(error.code) {
            case 'auth/user-not-found':
              errorElement.textContent = 'T√†i kho·∫£n kh√¥ng t·ªìn t·∫°i!';
              break;
            case 'auth/wrong-password':
              errorElement.textContent = 'M·∫≠t kh·∫©u kh√¥ng ch√≠nh x√°c!';
              break;
            default:
              errorElement.textContent = 'ƒêƒÉng nh·∫≠p th·∫•t b·∫°i: ' + error.message;
          }
        });
    });
    
    // X·ª≠ l√Ω ƒëƒÉng k√Ω
    document.getElementById('registerBtn').addEventListener('click', () => {
      const name = document.getElementById('registerName').value.trim();
      const email = document.getElementById('registerEmail').value.trim();
      const password = document.getElementById('registerPassword').value;
      const errorElement = document.getElementById('registerError');
      
      if (!name || !email || !password) {
        errorElement.textContent = 'Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!';
        return;
      }
      
      if (password.length < 6) {
        errorElement.textContent = 'M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±!';
        return;
      }
      
      auth.createUserWithEmailAndPassword(email, password)
        .then((userCredential) => {
          // ƒêƒÉng k√Ω th√†nh c√¥ng, c·∫≠p nh·∫≠t t√™n hi·ªÉn th·ªã
          return userCredential.user.updateProfile({
            displayName: name
          }).then(() => {
            // T·∫°o h·ªì s∆° ng∆∞·ªùi d√πng trong database
            return db.ref('users/' + userCredential.user.uid).set({
              displayName: name,
              email: email,
              points: 0,
              unoWins: 0,
              chessWins: 0,
              totalGames: 0,
              createdAt: firebase.database.ServerValue.TIMESTAMP
            });
          }).then(() => {
            document.getElementById('authModal').style.display = 'none';
            loadUserProfile(userCredential.user);
          });
        })
        .catch((error) => {
          // X·ª≠ l√Ω l·ªói ƒëƒÉng k√Ω
          switch(error.code) {
            case 'auth/email-already-in-use':
              errorElement.textContent = 'Email ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng!';
              break;
            case 'auth/invalid-email':
              errorElement.textContent = 'Email kh√¥ng h·ª£p l·ªá!';
              break;
            default:
              errorElement.textContent = 'ƒêƒÉng k√Ω th·∫•t b·∫°i: ' + error.message;
          }
        });
    });
    
    // X·ª≠ l√Ω ƒëƒÉng nh·∫≠p v·ªõi Google
    document.getElementById('googleLoginBtn').addEventListener('click', loginWithGoogle);
    document.getElementById('googleRegisterBtn').addEventListener('click', loginWithGoogle);
    
    function loginWithGoogle() {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider)
        .then((result) => {
          const user = result.user;
          const isNewUser = result.additionalUserInfo.isNewUser;
          
          if (isNewUser) {
            // T·∫°o h·ªì s∆° ng∆∞·ªùi d√πng m·ªõi trong database
            return db.ref('users/' + user.uid).set({
              displayName: user.displayName,
              email: user.email,
              points: 0,
              unoWins: 0,
              chessWins: 0,
              totalGames: 0,
              createdAt: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
              document.getElementById('authModal').style.display = 'none';
              loadUserProfile(user);
            });
          } else {
            document.getElementById('authModal').style.display = 'none';
            loadUserProfile(user);
          }
        })
        .catch((error) => {
          console.error('ƒêƒÉng nh·∫≠p Google th·∫•t b·∫°i:', error);
        });
    }
    
    // X·ª≠ l√Ω ƒëƒÉng nh·∫≠p kh√°ch
    document.getElementById('guestLoginBtn').addEventListener('click', () => {
      const guestName = document.getElementById('guestName').value.trim();
      const errorElement = document.getElementById('guestError');
      
      if (!guestName) {
        errorElement.textContent = 'Vui l√≤ng nh·∫≠p t√™n c·ªßa b·∫°n!';
        return;
      }
      
      // L∆∞u th√¥ng tin ng∆∞·ªùi ch∆°i kh√°ch
      currentUser = {
        uid: 'guest_' + Date.now(),
        displayName: guestName,
        email: '',
        isGuest: true,
        points: 0,
        unoWins: 0,
        chessWins: 0,
        totalGames: 0
      };
      
      // L∆∞u th√¥ng tin v√†o localStorage cho c·∫£ guestUser v√† userInfo
      localStorage.setItem('guestUser', JSON.stringify(currentUser));
      localStorage.setItem('userInfo', JSON.stringify({
        uid: currentUser.uid,
        displayName: currentUser.displayName,
        isGuest: true,
        points: 0
      }));
      
      // ƒê√≥ng modal v√† hi·ªÉn th·ªã th√¥ng tin ng∆∞·ªùi d√πng
      document.getElementById('authModal').style.display = 'none';
      updateUserProfileUI();
      
      // T·∫£i danh s√°ch ph√≤ng
      loadRooms();
    });
    
    // X·ª≠ l√Ω ƒëƒÉng xu·∫•t
    document.getElementById('logoutBtn').addEventListener('click', () => {
      auth.signOut().then(() => {
        // X√≥a th√¥ng tin ng∆∞·ªùi d√πng kh√°ch n·∫øu c√≥
        localStorage.removeItem('guestUser');
        
        // ƒê·∫∑t l·∫°i th√¥ng tin ng∆∞·ªùi d√πng
        currentUser = {
          uid: null,
          displayName: '',
          email: '',
          isGuest: true,
          points: 0,
          unoWins: 0,
          chessWins: 0,
          totalGames: 0
        };
        
        // ·∫®n dropdown h·ªì s∆°
        document.getElementById('profileDropdown').classList.remove('show');
        
        // ·∫®n th√¥ng tin ng∆∞·ªùi d√πng
        document.getElementById('userProfile').style.display = 'none';
        
        // Hi·ªÉn th·ªã modal ƒëƒÉng nh·∫≠p
        document.getElementById('authModal').style.display = 'flex';
      }).catch((error) => {
        console.error('ƒêƒÉng xu·∫•t th·∫•t b·∫°i:', error);
      });
    });
    
    // X·ª≠ l√Ω n√∫t admin
    document.getElementById('adminBtn').addEventListener('click', () => {
      // Ki·ªÉm tra quy·ªÅn admin tr∆∞·ªõc khi chuy·ªÉn h∆∞·ªõng
      const userInfo = JSON.parse(localStorage.getItem('userInfo')) || {};
      const adminEmails = ['micovan108@gmail.com', 'admin@example.com'];
      
      if (userInfo.email && adminEmails.includes(userInfo.email)) {
        window.location.href = 'admin.html';
      } else {
        alert('B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang qu·∫£n tr·ªã!');
      }
    });
    
    // X·ª≠ l√Ω hi·ªÉn th·ªã/·∫©n dropdown h·ªì s∆°
    document.getElementById('userProfile').addEventListener('click', () => {
      document.getElementById('profileDropdown').classList.toggle('show');
    });
    
    // ƒê√≥ng dropdown khi click ra ngo√†i
    window.addEventListener('click', (event) => {
      const dropdown = document.getElementById('profileDropdown');
      const profile = document.getElementById('userProfile');
      
      if (dropdown.classList.contains('show') && 
          !profile.contains(event.target) && 
          !dropdown.contains(event.target)) {
        dropdown.classList.remove('show');
      }
    });
    
    // X·ª≠ l√Ω ch·ªçn lo·∫°i game trong modal t·∫°o ph√≤ng
    document.querySelectorAll('.game-type-option').forEach(option => {
      option.addEventListener('click', () => {
        // X√≥a class selected t·ª´ t·∫•t c·∫£ c√°c option
        document.querySelectorAll('.game-type-option').forEach(opt => opt.classList.remove('selected'));
        
        // Th√™m class selected cho option ƒë∆∞·ª£c ch·ªçn
        option.classList.add('selected');
        
        // L∆∞u lo·∫°i game ƒë√£ ch·ªçn
        selectedGameType = option.getAttribute('data-game');
      });
    });
    
    // X·ª≠ l√Ω hi·ªÉn th·ªã modal t·∫°o ph√≤ng
    document.getElementById('createRoomBtn').addEventListener('click', () => {
      if (!currentUser.uid) {
        alert('Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi t·∫°o ph√≤ng!');
        return;
      }
      
      document.getElementById('createRoomModal').style.display = 'flex';
    });
    
    // X·ª≠ l√Ω ƒë√≥ng modal t·∫°o ph√≤ng
    document.getElementById('cancelCreateRoomBtn').addEventListener('click', () => {
      document.getElementById('createRoomModal').style.display = 'none';
      document.getElementById('roomNameInput').value = '';
      document.getElementById('createRoomError').textContent = '';
    });
    
    // X·ª≠ l√Ω t·∫°o ph√≤ng
    document.getElementById('confirmCreateRoomBtn').addEventListener('click', async () => {

    const roomName = document.getElementById('roomNameInput').value.trim();
      const errorElement = document.getElementById('createRoomError');
      
      if (!roomName) {
        errorElement.textContent = 'Vui l√≤ng nh·∫≠p t√™n ph√≤ng!';
        return;
      }
      
      if (!currentUser.uid) {
        errorElement.textContent = 'Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi t·∫°o ph√≤ng!';
        return;
      }
      
      // Ki·ªÉm tra xem t√™n ph√≤ng ƒë√£ t·ªìn t·∫°i ch∆∞a
      roomsRef.orderByChild('name').equalTo(roomName).once('value', snapshot => {
        if (snapshot.exists()) {
          errorElement.textContent = 'T√™n ph√≤ng ƒë√£ t·ªìn t·∫°i, vui l√≤ng ch·ªçn t√™n kh√°c!';
          return;
        }
        
        // T·∫°o ph√≤ng m·ªõi
  const playerName = localStorage.getItem('playerName') || 'Ng∆∞·ªùi d√πng';

  const newRoomRef = roomsRef.push();
  const roomData = {
    name: roomName,
    gameType: selectedGameType,
    createdAt: firebase.database.ServerValue.TIMESTAMP,
    status: 'waiting',
    host: currentUser.uid, // S·ª≠ d·ª•ng uid c·ªßa ng∆∞·ªùi d√πng hi·ªán t·∫°i thay v√¨ displayName ƒë·ªÉ ƒë·ªìng nh·∫•t v·ªõi UNO
    players: {}
  };
  
  // Th√™m ng∆∞·ªùi t·∫°o ph√≤ng v√†o danh s√°ch ng∆∞·ªùi ch∆°i
  roomData.players[currentUser.uid] = {
    displayName: currentUser.displayName,
    points: currentUser.points,
    isHost: true,
    joinedAt: firebase.database.ServerValue.TIMESTAMP
  };


        
        // L∆∞u th√¥ng tin ph√≤ng v√†o database
        newRoomRef.set(roomData, error => {
          if (error) {
            errorElement.textContent = 'C√≥ l·ªói x·∫£y ra khi t·∫°o ph√≤ng: ' + error.message;
            return;
          }
          
          // ƒê√≥ng modal t·∫°o ph√≤ng
          document.getElementById('createRoomModal').style.display = 'none';
          document.getElementById('roomNameInput').value = '';
          
          // L∆∞u ID ph√≤ng v√†o localStorage
          localStorage.setItem('selectedRoomId', newRoomRef.key);
          
          // Chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang game t∆∞∆°ng ·ª©ng
          if (selectedGameType === 'uno') {
            window.location.href = 'uno.html';
          } else if (selectedGameType === 'chess') {
            window.location.href = 'covua.html';
          }
        });
      });
    });
    
    
    // H√†m t·∫£i danh s√°ch ph√≤ng t·ª´ Firebase v√† hi·ªÉn th·ªã trong s·∫£nh ch·ªù
    function loadRooms() {
      const roomsContainer = document.getElementById('roomsContainer');
      roomsContainer.innerHTML = '<div class="loading-rooms">ƒêang t·∫£i danh s√°ch ph√≤ng...</div>';
      
      // L·∫Øng nghe s·ª± thay ƒë·ªïi c·ªßa danh s√°ch ph√≤ng
      roomsRef.on('value', snapshot => {
        if (!snapshot.exists()) {
          roomsContainer.innerHTML = '<div class="no-rooms">Ch∆∞a c√≥ ph√≤ng n√†o ƒë∆∞·ª£c t·∫°o. H√£y t·∫°o ph√≤ng m·ªõi!</div>';
          return;
        }
        
        // X√≥a n·ªôi dung c≈©
        roomsContainer.innerHTML = '';
        
        // L·∫•y danh s√°ch ph√≤ng
        const rooms = snapshot.val();
        const roomIds = Object.keys(rooms);
        
        // L·ªçc ph√≤ng theo b·ªô l·ªçc hi·ªán t·∫°i
        const currentFilter = document.querySelector('.filter-btn.active').getAttribute('data-filter');
        
        // Ki·ªÉm tra xem c√≥ ph√≤ng n√†o kh√¥ng
        let visibleRooms = 0;
        
        // Hi·ªÉn th·ªã danh s√°ch ph√≤ng
        roomIds.forEach(roomId => {
          const room = rooms[roomId];
          
          // Ki·ªÉm tra b·ªô l·ªçc
          if (currentFilter !== 'all' && room.gameType !== currentFilter) {
            return;
          }
          
          visibleRooms++;
          
          // T·∫°o ph·∫ßn t·ª≠ hi·ªÉn th·ªã ph√≤ng
          const roomCard = document.createElement('div');
          roomCard.className = 'room-card';
          
          // ƒê·∫øm s·ªë ng∆∞·ªùi ch∆°i trong ph√≤ng
          const playerCount = room.players ? Object.keys(room.players).length : 0;
          
          // X√°c ƒë·ªãnh tr·∫°ng th√°i ph√≤ng
          const isPlaying = room.status === 'playing';
          const statusClass = isPlaying ? 'playing' : 'waiting';
          const statusText = isPlaying ? 'ƒêang ch∆°i' : 'ƒêang ch·ªù';
          
          // X√°c ƒë·ªãnh lo·∫°i game
          const gameTypeText = room.gameType === 'uno' ? 'UNO' : 'C·ªù Vua';
          const gameTypeClass = room.gameType;
          
          // X√°c ƒë·ªãnh s·ªë ng∆∞·ªùi ch∆°i t·ªëi ƒëa
          const maxPlayers = room.gameType === 'uno' ? 4 : 2;
          
          // T·∫°o n·ªôi dung cho ph√≤ng
          roomCard.innerHTML = `
            <div class="room-name">${room.name}</div>
            <div class="room-type ${gameTypeClass}">${gameTypeText}</div>
            <div class="room-players">${playerCount}/${maxPlayers} ng∆∞·ªùi ch∆°i</div>
            <div class="room-status ${statusClass}">${statusText}</div>
            <div class="room-actions">
              ${!isPlaying ? 
                `<button class="join-btn" data-room-id="${roomId}" data-game-type="${room.gameType}">Tham gia</button>` : 
                `<button class="join-btn" disabled>ƒêang ch∆°i</button>`
              }
              <button class="spectate-btn" data-room-id="${roomId}" data-game-type="${room.gameType}" title="Xem ph√≤ng">
                <span>üëÅÔ∏è</span>
              </button>
            </div>
          `;
          
          // Th√™m ph√≤ng v√†o container
          roomsContainer.appendChild(roomCard);
        });
        
        // Hi·ªÉn th·ªã th√¥ng b√°o n·∫øu kh√¥ng c√≥ ph√≤ng n√†o
        if (visibleRooms === 0) {
          roomsContainer.innerHTML = `<div class="no-rooms">Kh√¥ng t√¨m th·∫•y ph√≤ng ${currentFilter !== 'all' ? currentFilter : ''} n√†o. H√£y t·∫°o ph√≤ng m·ªõi!</div>`;
        }
        
        // Th√™m s·ª± ki·ªán cho c√°c n√∫t tham gia v√† xem ph√≤ng
        addRoomButtonEvents();
      });
    }
    
    // Th√™m s·ª± ki·ªán cho c√°c n√∫t trong danh s√°ch ph√≤ng
    function addRoomButtonEvents() {
      // S·ª± ki·ªán cho n√∫t tham gia ph√≤ng
      document.querySelectorAll('.join-btn').forEach(button => {
        if (button.disabled) return;
        
        button.addEventListener('click', () => {
          if (!currentUser.uid) {
            alert('Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi tham gia ph√≤ng!');
            return;
          }
          
          const roomId = button.getAttribute('data-room-id');
          const gameType = button.getAttribute('data-game-type');
          
          // L∆∞u ID ph√≤ng v√†o localStorage
          localStorage.setItem('selectedRoomId', roomId);
          
          // Chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang game t∆∞∆°ng ·ª©ng
          if (gameType === 'uno') {
            window.location.href = 'uno.html';
          } else if (gameType === 'chess') {
            window.location.href = 'covua.html';
          }
        });
      });
      
      // S·ª± ki·ªán cho n√∫t xem ph√≤ng
      document.querySelectorAll('.spectate-btn').forEach(button => {
        button.addEventListener('click', () => {
          if (!currentUser.uid) {
            alert('Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi xem ph√≤ng!');
            return;
          }
          
          const roomId = button.getAttribute('data-room-id');
          const gameType = button.getAttribute('data-game-type');
          
          // L∆∞u ID ph√≤ng v√† tr·∫°ng th√°i ng∆∞·ªùi xem v√†o localStorage
          localStorage.setItem('selectedRoomId', roomId);
          localStorage.setItem('isSpectator', 'true');
          
          // Chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang game t∆∞∆°ng ·ª©ng
          if (gameType === 'uno') {
            window.location.href = 'uno.html';
          } else if (gameType === 'chess') {
            window.location.href = 'covua.html';
          }
        });
      });
    }
    
    // X·ª≠ l√Ω b·ªô l·ªçc ph√≤ng
    document.querySelectorAll('.filter-btn').forEach(button => {
      button.addEventListener('click', () => {
        // X√≥a class active t·ª´ t·∫•t c·∫£ c√°c n√∫t
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        
        // Th√™m class active cho n√∫t ƒë∆∞·ª£c ch·ªçn
        button.classList.add('active');
        
        // T·∫£i l·∫°i danh s√°ch ph√≤ng v·ªõi b·ªô l·ªçc m·ªõi
        loadRooms();
      });
    });
    
    // H√†m t·∫£i th√¥ng tin h·ªì s∆° ng∆∞·ªùi d√πng
    function loadUserProfile(user) {
      if (!user) return;
      
      // L·∫•y th√¥ng tin ng∆∞·ªùi d√πng t·ª´ database
      db.ref('users/' + user.uid).once('value', snapshot => {
        if (snapshot.exists()) {
          // C·∫≠p nh·∫≠t th√¥ng tin ng∆∞·ªùi d√πng t·ª´ database
          const userData = snapshot.val();
          currentUser = {
            uid: user.uid,
            displayName: userData.displayName || user.displayName,
            email: userData.email || user.email,
            isGuest: false,
            points: userData.points || 0,
            unoWins: userData.unoWins || 0,
            chessWins: userData.chessWins || 0,
            totalGames: userData.totalGames || 0
          };
        } else {
          // T·∫°o h·ªì s∆° ng∆∞·ªùi d√πng m·ªõi n·∫øu ch∆∞a t·ªìn t·∫°i
          currentUser = {
            uid: user.uid,
            displayName: user.displayName,
            email: user.email,
            isGuest: false,
            points: 0,
            unoWins: 0,
            chessWins: 0,
            totalGames: 0
          };
          
          db.ref('users/' + user.uid).set({
            displayName: user.displayName,
            email: user.email,
            points: 0,
            unoWins: 0,
            chessWins: 0,
            totalGames: 0,
            createdAt: firebase.database.ServerValue.TIMESTAMP
          });
        }
        
        // L∆∞u th√¥ng tin ng∆∞·ªùi d√πng v√†o localStorage ƒë·ªÉ c√°c trang game c√≥ th·ªÉ s·ª≠ d·ª•ng
        localStorage.setItem('userInfo', JSON.stringify({
          uid: currentUser.uid,
          displayName: currentUser.displayName,
          email: currentUser.email,
          isGuest: currentUser.isGuest,
          points: currentUser.points,
          photoURL: user.photoURL || null
        }));
        
        // C·∫≠p nh·∫≠t giao di·ªán ng∆∞·ªùi d√πng
        updateUserProfileUI();
        
        // T·∫£i danh s√°ch ph√≤ng
        loadRooms();
      });
    }
    
    // H√†m c·∫≠p nh·∫≠t giao di·ªán h·ªì s∆° ng∆∞·ªùi d√πng
    function updateUserProfileUI() {
      if (currentUser.uid) {
        // Hi·ªÉn th·ªã th√¥ng tin ng∆∞·ªùi d√πng
        document.getElementById('userProfile').style.display = 'flex';
        document.getElementById('profileUserName').textContent = currentUser.displayName;
        document.getElementById('profileUserPoints').textContent = currentUser.points + ' ƒëi·ªÉm';
        
        // C·∫≠p nh·∫≠t avatar
        const avatarElement = document.getElementById('userAvatar');
        avatarElement.textContent = currentUser.displayName.charAt(0).toUpperCase();
        
        // C·∫≠p nh·∫≠t th√¥ng tin trong dropdown h·ªì s∆°
        document.getElementById('totalPoints').textContent = currentUser.points;
        document.getElementById('unoWins').textContent = currentUser.unoWins;
        document.getElementById('chessWins').textContent = currentUser.chessWins;
        document.getElementById('totalGames').textContent = currentUser.totalGames;
        
        // Hi·ªÉn th·ªã n√∫t admin ch·ªâ cho t√†i kho·∫£n admin
        const adminBtn = document.getElementById('adminBtn');
        const adminEmails = ['micovan108@gmail.com', 'admin@example.com'];
        if (currentUser.email && adminEmails.includes(currentUser.email)) {
          adminBtn.style.display = 'block';
        } else {
          adminBtn.style.display = 'none';
        }
      } else {
        // ·∫®n th√¥ng tin ng∆∞·ªùi d√πng n·∫øu ch∆∞a ƒëƒÉng nh·∫≠p
        document.getElementById('userProfile').style.display = 'none';
      }
    }
    
    // Ki·ªÉm tra tr·∫°ng th√°i ƒëƒÉng nh·∫≠p khi trang web ƒë∆∞·ª£c t·∫£i
    window.addEventListener('DOMContentLoaded', () => {
      // Ki·ªÉm tra xem c√≥ ng∆∞·ªùi d√πng ƒë√£ ƒëƒÉng nh·∫≠p kh√¥ng
      auth.onAuthStateChanged(user => {
        if (user) {
          // Ng∆∞·ªùi d√πng ƒë√£ ƒëƒÉng nh·∫≠p
          document.getElementById('authModal').style.display = 'none';
          loadUserProfile(user);
        } else {
          // Ki·ªÉm tra xem c√≥ th√¥ng tin ng∆∞·ªùi d√πng kh√°ch kh√¥ng
          const guestUserData = localStorage.getItem('guestUser');
          if (guestUserData) {
            currentUser = JSON.parse(guestUserData);
            document.getElementById('authModal').style.display = 'none';
            updateUserProfileUI();
            
            // T·∫£i danh s√°ch ph√≤ng
            loadRooms();
          }
        }
      });
    });
    
    // Kh·ªüi t·∫°o khung chat
    let chatContainer;
    let chatMessages;
    let chatInput;
    let chatMessagesRef;
    let chatCleanupInterval;
    
    function initializeChat() {
      if (!currentUser.uid) return;
      
      // T·∫°o khung chat n·∫øu ch∆∞a t·ªìn t·∫°i
      if (!document.querySelector('.chat-container')) {
        // T·∫°o container cho khung chat
        chatContainer = document.createElement('div');
        chatContainer.className = 'chat-container';
        chatContainer.innerHTML = `
          <div class="chat-header">
            <div class="chat-title">Chat C√¥ng C·ªông</div>
            <button class="chat-toggle">‚àí</button>
          </div>
          <div class="chat-messages"></div>
          <div class="chat-input-container">
            <input type="text" class="chat-input" placeholder="Nh·∫≠p tin nh·∫Øn...">
            <button class="chat-send">‚û§</button>
          </div>
        `;
        document.body.appendChild(chatContainer);
        
        // L·∫•y c√°c ph·∫ßn t·ª≠ c·∫ßn thi·∫øt
        chatMessages = chatContainer.querySelector('.chat-messages');
        chatInput = chatContainer.querySelector('.chat-input');
        const chatToggle = chatContainer.querySelector('.chat-toggle');
        const chatSend = chatContainer.querySelector('.chat-send');
        
        // X·ª≠ l√Ω s·ª± ki·ªán thu g·ªçn/m·ªü r·ªông khung chat
        chatToggle.addEventListener('click', () => {
          chatContainer.classList.toggle('minimized');
          chatToggle.textContent = chatContainer.classList.contains('minimized') ? '+' : '‚àí';
        });
        
        // X·ª≠ l√Ω s·ª± ki·ªán g·ª≠i tin nh·∫Øn
        function sendMessage() {
          const message = chatInput.value.trim();
          if (message && currentUser.uid) {
            // T·∫°o tin nh·∫Øn m·ªõi
            const newMessage = {
              text: message,
              sender: currentUser.uid,
              senderName: currentUser.displayName,
              timestamp: firebase.database.ServerValue.TIMESTAMP
            };
            
            // L∆∞u tin nh·∫Øn v√†o Firebase
            chatMessagesRef.push(newMessage);
            
            // X√≥a n·ªôi dung input
            chatInput.value = '';
          }
        }
        
        // X·ª≠ l√Ω s·ª± ki·ªán khi nh·∫•n n√∫t g·ª≠i
        chatSend.addEventListener('click', sendMessage);
        
        // X·ª≠ l√Ω s·ª± ki·ªán khi nh·∫•n Enter
        chatInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            sendMessage();
          }
        });
      }
      
      // K·∫øt n·ªëi v·ªõi Firebase ƒë·ªÉ l·∫•y tin nh·∫Øn
      chatMessagesRef = db.ref('chat/messages');
      
      // L·∫Øng nghe s·ª± ki·ªán khi c√≥ tin nh·∫Øn m·ªõi
      chatMessagesRef.on('child_added', (snapshot) => {
        const message = snapshot.val();
        if (!message) return;
        
        // T·∫°o ph·∫ßn t·ª≠ hi·ªÉn th·ªã tin nh·∫Øn
        const messageElement = document.createElement('div');
        messageElement.className = `chat-message ${message.sender === currentUser.uid ? 'sent' : 'received'}`;
        
        // ƒê·ªãnh d·∫°ng th·ªùi gian
        const messageTime = new Date(message.timestamp);
        const timeString = messageTime.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
        
        // Th√™m n·ªôi dung tin nh·∫Øn
        messageElement.innerHTML = `
          ${message.sender !== currentUser.uid ? `<div class="message-sender">${message.senderName}</div>` : ''}
          <div class="message-text">${message.text}</div>
          <div class="message-time">${timeString}</div>
        `;
        
        // Th√™m tin nh·∫Øn v√†o khung chat
        chatMessages.appendChild(messageElement);
        
        // Cu·ªôn xu·ªëng tin nh·∫Øn m·ªõi nh·∫•t
        chatMessages.scrollTop = chatMessages.scrollHeight;
      });
      
      // Thi·∫øt l·∫≠p interval ƒë·ªÉ x√≥a tin nh·∫Øn c≈© sau m·ªói 1 gi·ªù
      if (!chatCleanupInterval) {
        chatCleanupInterval = setInterval(cleanupOldMessages, 60 * 60 * 1000); // 1 gi·ªù
      }
    }
    
    // H√†m x√≥a tin nh·∫Øn c≈©
    function cleanupOldMessages() {
      if (!chatMessagesRef) return;
      
      // L·∫•y th·ªùi gian hi·ªán t·∫°i
      const now = new Date().getTime();
      // Th·ªùi gian 1 gi·ªù tr∆∞·ªõc
      const oneHourAgo = now - (60 * 60 * 1000);
      
      // Truy v·∫•n tin nh·∫Øn c≈© h∆°n 1 gi·ªù
      chatMessagesRef.orderByChild('timestamp').endAt(oneHourAgo).once('value', (snapshot) => {
        // X√≥a t·ª´ng tin nh·∫Øn c≈©
        snapshot.forEach((childSnapshot) => {
          chatMessagesRef.child(childSnapshot.key).remove();
        });
      });
    }
    
    // Kh·ªüi t·∫°o chat khi ng∆∞·ªùi d√πng ƒë√£ ƒëƒÉng nh·∫≠p
    auth.onAuthStateChanged(user => {
      if (user) {
        // Kh·ªüi t·∫°o chat sau khi ƒë√£ t·∫£i th√¥ng tin ng∆∞·ªùi d√πng
        setTimeout(initializeChat, 1000);
      }
    });
  </script>
</body>
</html>