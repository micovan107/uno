<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>C·ªù Vua Online - Lazi Games</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #146c43;
      color: #fff;
      text-align: center;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .room-info {
      background: #1e7e34;
      padding: 10px 20px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }
    .room-name {
      font-size: 18px;
      font-weight: bold;
    }
    .player-list {
      display: flex;
      justify-content: space-around;
      margin-bottom: 20px;
    }
    .player {
      background: rgba(0,0,0,0.2);
      padding: 10px 15px;
      border-radius: 8px;
      min-width: 200px;
    }
    .player.current {
      background: #28a745;
      box-shadow: 0 0 10px rgba(255,255,255,0.5);
    }
    .player.host::after {
      content: 'üëë';
      margin-left: 5px;
    }
    .player-name {
      font-weight: bold;
      margin-bottom: 5px;
    }
    .player-points {
      font-size: 14px;
      color: rgba(255,255,255,0.8);
    }
    .game-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 20px;
    }
    .board {
      display: grid;
      grid-template-columns: repeat(8, 50px);
      grid-template-rows: repeat(8, 50px);
      gap: 0;
      margin: 20px auto;
      border: 5px solid #000;
      box-shadow: 0 0 15px rgba(0,0,0,0.5);
    }
    .square {
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 30px;
      cursor: pointer;
      user-select: none;
    }
    .white {
      background-color: #f0d9b5;
      color: #000;
    }
    .black {
      background-color: #b58863;
      color: #000;
    }
    .highlight {
      background-color: rgba(255, 255, 0, 0.5);
    }
    .check {
      background-color: rgba(255, 0, 0, 0.5);
    }
    .last-move {
      background-color: rgba(0, 255, 0, 0.3);
    }
    .possible-move {
      position: relative;
    }
    .possible-move::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      background-color: rgba(0, 0, 0, 0.3);
      border-radius: 50%;
    }
    .possible-capture {
      position: relative;
    }
    .possible-capture::after {
      content: '';
      position: absolute;
      width: 46px;
      height: 46px;
      border: 2px solid rgba(255, 0, 0, 0.7);
      border-radius: 50%;
    }
    .game-status {
      margin: 15px 0;
      font-size: 18px;
      font-weight: bold;
    }
    .btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
      transition: background-color 0.2s;
    }
    .btn:hover {
      background: #218838;
    }
    .btn:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }
    .btn-danger {
      background: #dc3545;
    }
    .btn-danger:hover {
      background: #c82333;
    }
    .promotion-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .promotion-content {
      background-color: #1e7e34;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
    }
    .promotion-title {
      margin-bottom: 15px;
      font-size: 18px;
    }
    .promotion-options {
      display: flex;
      justify-content: center;
      gap: 15px;
    }
    .piece {
      font-size: 40px;
      cursor: pointer;
      padding: 10px;
      border-radius: 5px;
      background-color: rgba(255, 255, 255, 0.1);
      transition: background-color 0.2s;
    }
    .piece:hover {
      background-color: rgba(255, 255, 255, 0.3);
    }
    .waiting-room {
      text-align: center;
      margin: 50px auto;
      max-width: 600px;
      background: #1e7e34;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0,0,0,0.3);
    }
    .waiting-title {
      font-size: 24px;
      margin-bottom: 20px;
    }
    .waiting-players {
      margin: 20px 0;
    }
    .chat-container {
      background: rgba(0,0,0,0.2);
      border-radius: 10px;
      padding: 15px;
      margin-top: 20px;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }
    .chat-messages {
      height: 200px;
      overflow-y: auto;
      background: rgba(0,0,0,0.3);
      border-radius: 5px;
      padding: 10px;
      margin-bottom: 10px;
      text-align: left;
    }
    .chat-input-container {
      display: flex;
      gap: 10px;
    }
    .chat-input {
      flex: 1;
      padding: 8px 12px;
      border: none;
      border-radius: 5px;
      background: rgba(255,255,255,0.9);
    }
    .chat-send-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
    }
    .message {
      margin-bottom: 8px;
      word-wrap: break-word;
    }
    .message-sender {
      font-weight: bold;
      margin-right: 5px;
    }
    .system-message {
      color: #ffc107;
      font-style: italic;
    }
    .spectator-badge {
      background: #6c757d;
      color: white;
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 12px;
      margin-left: 5px;
    }
    @media (max-width: 768px) {
      .board {
        grid-template-columns: repeat(8, 40px);
        grid-template-rows: repeat(8, 40px);
      }
      .square {
        width: 40px;
        height: 40px;
        font-size: 24px;
      }
      .possible-capture::after {
        width: 36px;
        height: 36px;
      }
      .player-list {
        flex-direction: column;
        align-items: center;
        gap: 10px;
      }
      .player {
        width: 80%;
      }
    }
  </style>
</head>
<body>
  <!-- Modal phong c·∫•p t·ªët -->
  <div id="promotion-modal" class="promotion-modal">
    <div class="promotion-content">
      <div class="promotion-title">Ch·ªçn qu√¢n c·ªù phong c·∫•p</div>
      <div class="promotion-options">
        <div class="piece" data-piece="q">‚ôï</div>
        <div class="piece" data-piece="r">‚ôñ</div>
        <div class="piece" data-piece="b">‚ôó</div>
        <div class="piece" data-piece="n">‚ôò</div>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="header">
      <h1>C·ªù Vua Online</h1>
      <button id="leaveRoomBtn" class="btn btn-danger">R·ªùi ph√≤ng</button>
    </div>

    <div class="room-info">
      <div class="room-name" id="roomName">Ph√≤ng: ...</div>
      <div id="gameStatus">ƒêang ch·ªù ng∆∞·ªùi ch∆°i...</div>
    </div>

    <div id="waitingRoom" class="waiting-room">
      <div class="waiting-title">ƒêang ch·ªù ng∆∞·ªùi ch∆°i</div>
      <div id="waitingPlayers" class="waiting-players"></div>
      <button id="startGameBtn" class="btn" style="display: none;">B·∫Øt ƒë·∫ßu tr√≤ ch∆°i</button>
    </div>

    <div id="gameBoard" style="display: none;">
      <div class="player-list" id="playerList"></div>

      <div class="game-container">
        <div id="status" class="game-status">L∆∞·ª£t c·ªßa: Tr·∫Øng</div>
        <div id="board" class="board"></div>
        <div id="message" style="margin-bottom: 10px;"></div>
        <div class="game-controls">
          <button id="restart-btn" class="btn" style="display: none;">Ch∆°i l·∫°i</button>
        </div>
      </div>
    </div>

    <div class="chat-container">
      <div id="chatMessages" class="chat-messages"></div>
      <div class="chat-input-container">
        <input type="text" id="chatInput" class="chat-input" placeholder="Nh·∫≠p tin nh·∫Øn..." />
        <button id="chatSendBtn" class="chat-send-btn">G·ª≠i</button>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

  <script>
    // C·∫•u h√¨nh Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBgITWCnQO7pW2-VOAgpKFsK6GN8H037HM",
      authDomain: "masoi-92684.firebaseapp.com",
      databaseURL: "https://masoi-92684-default-rtdb.firebaseio.com",
      projectId: "masoi-92684",
      storageBucket: "masoi-92684.firebasestorage.app",
      messagingSenderId: "1030518945375",
      appId: "1:1030518945375:web:a531a0233c0dcbde120dea",
      measurementId: "G-QNS4GVQ178"
    };
    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();
    
    // Bi·∫øn l∆∞u tr·ªØ th√¥ng tin tr√≤ ch∆°i
    let game = new Chess();
    let selectedSquare = null;
    let promotionMove = null;
    let currentUser = null;
    let currentRoomId = null;
    let currentRoomName = null;
    let isSpectator = false;
    let isHost = false;
    let playerColor = null; // 'w' ho·∫∑c 'b'
    let opponentId = null;
    
    // Tham chi·∫øu ƒë·∫øn c√°c listener Firebase
    let gameStateRef = null;
    let roomPlayersRef = null;
    let chatRef = null;
    
    // Kh·ªüi t·∫°o khi trang ƒë∆∞·ª£c t·∫£i
    window.addEventListener('DOMContentLoaded', () => {
      // L·∫•y th√¥ng tin ng∆∞·ªùi d√πng t·ª´ localStorage
      const userInfo = JSON.parse(localStorage.getItem('userInfo'));
      if (!userInfo || !userInfo.uid) {
        // Chuy·ªÉn h∆∞·ªõng v·ªÅ trang ch·ªß n·∫øu ch∆∞a ƒëƒÉng nh·∫≠p
        window.location.href = 'trangchu.html';
        return;
      }
      
      currentUser = userInfo;
      
      // Ki·ªÉm tra xem ng∆∞·ªùi d√πng c√≥ ph·∫£i l√† ng∆∞·ªùi xem kh√¥ng
      isSpectator = localStorage.getItem('isSpectator') === 'true';
      
      // L·∫•y ID ph√≤ng t·ª´ localStorage
      const roomId = localStorage.getItem('selectedRoomId');
      if (!roomId) {
        // Chuy·ªÉn h∆∞·ªõng v·ªÅ trang ch·ªß n·∫øu kh√¥ng c√≥ ID ph√≤ng
        window.location.href = 'trangchu.html';
        return;
      }
      
      // L·∫•y th√¥ng tin ph√≤ng t·ª´ Firebase
      db.ref('rooms/' + roomId).once('value', snapshot => {
        if (!snapshot.exists()) {
          // Chuy·ªÉn h∆∞·ªõng v·ªÅ trang ch·ªß n·∫øu ph√≤ng kh√¥ng t·ªìn t·∫°i
          window.location.href = 'trangchu.html';
          return;
        }
        
        const roomData = snapshot.val();
        currentRoomId = roomId;
        currentRoomName = roomData.name;
        
        // Hi·ªÉn th·ªã t√™n ph√≤ng
        document.getElementById('roomName').textContent = 'Ph√≤ng: ' + roomData.name;
        
        // Tham gia ph√≤ng ho·∫∑c xem ph√≤ng
        if (isSpectator) {
          spectateRoom(roomId, roomData.name);
        } else {
          joinRoom(roomId, roomData.name);
        }
      });
      
      // Th√™m s·ª± ki·ªán cho c√°c n√∫t
      document.getElementById('leaveRoomBtn').addEventListener('click', leaveRoom);
      document.getElementById('startGameBtn').addEventListener('click', startGame);
      document.getElementById('chatSendBtn').addEventListener('click', sendChatMessage);
      document.getElementById('chatInput').addEventListener('keypress', e => {
        if (e.key === 'Enter') sendChatMessage();
      });
      document.getElementById('restart-btn').addEventListener('click', restartGame);
    });
    
    // H√†m tham gia ph√≤ng
    function joinRoom(roomId, roomName) {
      // Ki·ªÉm tra xem ng∆∞·ªùi d√πng ƒë√£ ƒëƒÉng nh·∫≠p ch∆∞a
      if (!currentUser) {
        alert('Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi tham gia ph√≤ng!');
        window.location.href = 'trangchu.html';
        return;
      }
      
      // C·∫≠p nh·∫≠t UI
      document.getElementById('waitingRoom').style.display = 'block';
      document.getElementById('gameBoard').style.display = 'none';
      
      // Th√™m ng∆∞·ªùi ch∆°i v√†o ph√≤ng
      const roomRef = db.ref('rooms/' + roomId);
      roomRef.once('value', snapshot => {
        if (!snapshot.exists()) {
          alert('Ph√≤ng kh√¥ng t·ªìn t·∫°i!');
          window.location.href = 'trangchu.html';
          return;
        }
        
        const roomData = snapshot.val();
        
        // Ki·ªÉm tra xem ph√≤ng ƒë√£ ƒë·∫ßy ch∆∞a
        const players = roomData.players || {};
        const playerCount = Object.keys(players).length;
        
        if (playerCount >= 2 && !players[currentUser.uid]) {
          alert('Ph√≤ng ƒë√£ ƒë·∫ßy!');
          isSpectator = true;
          spectateRoom(roomId, roomName);
          return;
        }
        
        // Ki·ªÉm tra xem ng∆∞·ªùi ch∆°i ƒë√£ tham gia ph√≤ng ch∆∞a
        if (!players[currentUser.uid]) {
          // Th√™m ng∆∞·ªùi ch∆°i v√†o ph√≤ng
          const playerData = {
            displayName: currentUser.displayName,
            points: currentUser.points || 0,
            isHost: playerCount === 0, // Ng∆∞·ªùi ch∆°i ƒë·∫ßu ti√™n l√† ch·ªß ph√≤ng
            joinedAt: firebase.database.ServerValue.TIMESTAMP
          };
          
          roomRef.child('players/' + currentUser.uid).set(playerData);
          
          // N·∫øu l√† ng∆∞·ªùi ch∆°i ƒë·∫ßu ti√™n, c·∫≠p nh·∫≠t host c·ªßa ph√≤ng
          if (playerCount === 0) {
            roomRef.update({ host: currentUser.uid });
            isHost = true;
          }
        } else {
          // Ng∆∞·ªùi ch∆°i ƒë√£ tham gia ph√≤ng tr∆∞·ªõc ƒë√≥
          isHost = players[currentUser.uid].isHost;
        }
        
        // L·∫Øng nghe thay ƒë·ªïi c·ªßa danh s√°ch ng∆∞·ªùi ch∆°i trong ph√≤ng
        listenToRoomPlayers(roomId);
        
        // L·∫Øng nghe thay ƒë·ªïi c·ªßa tr√≤ ch∆°i n·∫øu ƒë√£ b·∫Øt ƒë·∫ßu
      if (roomData.status === 'playing') {
        listenToGameChanges(roomId);
        document.getElementById('waitingRoom').style.display = 'none';
        document.getElementById('gameBoard').style.display = 'block';
        
        // ƒê·∫£m b·∫£o b√†n c·ªù ƒë∆∞·ª£c kh·ªüi t·∫°o cho ng∆∞·ªùi ch∆°i th·ª© hai
        setTimeout(() => {
          console.log('ƒêang c·ªë g·∫Øng hi·ªÉn th·ªã b√†n c·ªù cho ng∆∞·ªùi ch∆°i th·ª© hai...');
          ensureBoardIsVisible();
          
          // Th√™m m·ªôt l·∫ßn ki·ªÉm tra n·ªØa sau 1 gi√¢y ƒë·ªÉ ƒë·∫£m b·∫£o b√†n c·ªù hi·ªÉn th·ªã
          setTimeout(() => {
            console.log('Ki·ªÉm tra l·∫°i b√†n c·ªù sau 1 gi√¢y...');
            ensureBoardIsVisible();
          }, 1000);
        }, 1000);
      }
        
        // L·∫Øng nghe tin nh·∫Øn chat
        listenToChat(roomId);
        
        // Hi·ªÉn th·ªã n√∫t b·∫Øt ƒë·∫ßu game n·∫øu l√† ch·ªß ph√≤ng
        document.getElementById('startGameBtn').style.display = isHost ? 'block' : 'none';
      });
    }
    
    // H√†m xem ph√≤ng
    function spectateRoom(roomId, roomName) {
      // Ki·ªÉm tra xem ng∆∞·ªùi d√πng ƒë√£ ƒëƒÉng nh·∫≠p ch∆∞a
      if (!currentUser) {
        alert('Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi xem ph√≤ng!');
        window.location.href = 'trangchu.html';
        return;
      }
      
      // C·∫≠p nh·∫≠t UI
      document.getElementById('waitingRoom').style.display = 'block';
      document.getElementById('gameBoard').style.display = 'none';
      
      // Th√™m ng∆∞·ªùi xem v√†o ph√≤ng
      const roomRef = db.ref('rooms/' + roomId);
      roomRef.once('value', snapshot => {
        if (!snapshot.exists()) {
          alert('Ph√≤ng kh√¥ng t·ªìn t·∫°i!');
          window.location.href = 'trangchu.html';
          return;
        }
        
        const roomData = snapshot.val();
        
        // Th√™m ng∆∞·ªùi xem v√†o ph√≤ng
        const spectatorData = {
          displayName: currentUser.displayName,
          joinedAt: firebase.database.ServerValue.TIMESTAMP
        };
        
        roomRef.child('spectators/' + currentUser.uid).set(spectatorData);
        
        // L·∫Øng nghe thay ƒë·ªïi c·ªßa danh s√°ch ng∆∞·ªùi ch∆°i trong ph√≤ng
        listenToRoomPlayers(roomId);
        
        // L·∫Øng nghe thay ƒë·ªïi c·ªßa tr√≤ ch∆°i n·∫øu ƒë√£ b·∫Øt ƒë·∫ßu
      if (roomData.status === 'playing') {
        listenToGameChanges(roomId);
        document.getElementById('waitingRoom').style.display = 'none';
        document.getElementById('gameBoard').style.display = 'block';
        
        // ƒê·∫£m b·∫£o b√†n c·ªù ƒë∆∞·ª£c kh·ªüi t·∫°o cho ng∆∞·ªùi xem
        setTimeout(() => {
          console.log('ƒêang c·ªë g·∫Øng hi·ªÉn th·ªã b√†n c·ªù cho ng∆∞·ªùi xem...');
          ensureBoardIsVisible();
          
          // Th√™m m·ªôt l·∫ßn ki·ªÉm tra n·ªØa sau 1 gi√¢y ƒë·ªÉ ƒë·∫£m b·∫£o b√†n c·ªù hi·ªÉn th·ªã
          setTimeout(() => {
            console.log('Ki·ªÉm tra l·∫°i b√†n c·ªù sau 1 gi√¢y...');
            ensureBoardIsVisible();
          }, 1000);
        }, 1000);
      }
        
        // L·∫Øng nghe tin nh·∫Øn chat
        listenToChat(roomId);
        
        // ·∫®n n√∫t b·∫Øt ƒë·∫ßu game v√¨ l√† ng∆∞·ªùi xem
        document.getElementById('startGameBtn').style.display = 'none';
      });
    }
    
    // H√†m l·∫Øng nghe thay ƒë·ªïi c·ªßa danh s√°ch ng∆∞·ªùi ch∆°i trong ph√≤ng
    function listenToRoomPlayers(roomId) {
      roomPlayersRef = db.ref('rooms/' + roomId);
      roomPlayersRef.on('value', snapshot => {
        if (!snapshot.exists()) {
          alert('Ph√≤ng ƒë√£ b·ªã x√≥a!');
          window.location.href = 'trangchu.html';
          return;
        }
        
        const roomData = snapshot.val();
        const players = roomData.players || {};
        const spectators = roomData.spectators || {};
        
        // C·∫≠p nh·∫≠t danh s√°ch ng∆∞·ªùi ch∆°i trong ph√≤ng ch·ªù
        const waitingPlayersElement = document.getElementById('waitingPlayers');
        waitingPlayersElement.innerHTML = '';
        
        // Hi·ªÉn th·ªã danh s√°ch ng∆∞·ªùi ch∆°i
        Object.keys(players).forEach(playerId => {
          const player = players[playerId];
          const playerElement = document.createElement('div');
          playerElement.className = 'player';
          if (player.isHost) playerElement.classList.add('host');
          
          playerElement.innerHTML = `
            <div class="player-name">${player.displayName}</div>
            <div class="player-points">${player.points} ƒëi·ªÉm</div>
          `;
          
          waitingPlayersElement.appendChild(playerElement);
        });
        
        // Hi·ªÉn th·ªã danh s√°ch ng∆∞·ªùi xem
        Object.keys(spectators).forEach(spectatorId => {
          const spectator = spectators[spectatorId];
          const spectatorElement = document.createElement('div');
          spectatorElement.className = 'player';
          
          spectatorElement.innerHTML = `
            <div class="player-name">${spectator.displayName} <span class="spectator-badge">Ng∆∞·ªùi xem</span></div>
          `;
          
          waitingPlayersElement.appendChild(spectatorElement);
        });
        
        // C·∫≠p nh·∫≠t tr·∫°ng th√°i ch·ªß ph√≤ng
        isHost = players[currentUser.uid]?.isHost || false;
        document.getElementById('startGameBtn').style.display = isHost && roomData.status !== 'playing' ? 'block' : 'none';
        
        // N·∫øu tr√≤ ch∆°i ƒë√£ b·∫Øt ƒë·∫ßu, hi·ªÉn th·ªã b√†n c·ªù
        if (roomData.status === 'playing') {
          document.getElementById('waitingRoom').style.display = 'none';
          document.getElementById('gameBoard').style.display = 'block';
          
          // C·∫≠p nh·∫≠t danh s√°ch ng∆∞·ªùi ch∆°i trong game
          updatePlayerList(roomData);

        // N·∫øu tr√≤ ch∆°i ƒë√£ b·∫Øt ƒë·∫ßu m√† client ch∆∞a l·∫Øng nghe game
        if (roomData.status === 'playing') {
          document.getElementById('waitingRoom').style.display = 'none';
          document.getElementById('gameBoard').style.display = 'block';

          // N·∫øu ch∆∞a l·∫Øng nghe th√¨ b·∫Øt ƒë·∫ßu
          if (!gameStateRef) {
            listenToGameChanges(roomId);

            setTimeout(() => {
              ensureBoardIsVisible();
              setTimeout(() => {
                ensureBoardIsVisible();
              }, 1000);
            }, 1000);
          }
        }
    
        }
      });
    }
    
    // H√†m c·∫≠p nh·∫≠t danh s√°ch ng∆∞·ªùi ch∆°i trong game
    function updatePlayerList(roomData) {
      const playerListElement = document.getElementById('playerList');
      playerListElement.innerHTML = '';
      
      const players = roomData.players || {};
      const playerIds = Object.keys(players);
      
      // N·∫øu c√≥ 2 ng∆∞·ªùi ch∆°i, hi·ªÉn th·ªã th√¥ng tin ng∆∞·ªùi ch∆°i
      if (playerIds.length === 2) {
        // X√°c ƒë·ªãnh m√†u qu√¢n c·ªù cho ng∆∞·ªùi ch∆°i hi·ªán t·∫°i
        if (!isSpectator && playerColor === null) {
          // Ng∆∞·ªùi ch∆°i ƒë·∫ßu ti√™n s·∫Ω ch∆°i qu√¢n tr·∫Øng
          const sortedPlayerIds = playerIds.sort((a, b) => players[a].joinedAt - players[b].joinedAt);
          playerColor = sortedPlayerIds[0] === currentUser.uid ? 'w' : 'b';
          
          // L∆∞u ID ƒë·ªëi th·ªß
          opponentId = sortedPlayerIds[0] === currentUser.uid ? sortedPlayerIds[1] : sortedPlayerIds[0];
        }
        
        // Hi·ªÉn th·ªã th√¥ng tin ng∆∞·ªùi ch∆°i
        playerIds.forEach(playerId => {
          const player = players[playerId];
          const playerElement = document.createElement('div');
          
          // X√°c ƒë·ªãnh m√†u qu√¢n c·ªù cho ng∆∞·ªùi ch∆°i n√†y
          const color = playerIds.indexOf(playerId) === 0 ? 'w' : 'b';
          const colorText = color === 'w' ? 'Tr·∫Øng' : 'ƒêen';
          
          // Th√™m class cho ng∆∞·ªùi ch∆°i hi·ªán t·∫°i v√† ch·ªß ph√≤ng
          playerElement.className = 'player';
          if (playerId === currentUser.uid) playerElement.classList.add('current');
          if (player.isHost) playerElement.classList.add('host');
          
          // Ki·ªÉm tra xem c√≥ ph·∫£i l∆∞·ª£t c·ªßa ng∆∞·ªùi ch∆°i n√†y kh√¥ng
          const isCurrentTurn = roomData.gameState && roomData.gameState.turn === color;
          if (isCurrentTurn) playerElement.classList.add('current');
          
          playerElement.innerHTML = `
            <div class="player-name">${player.displayName} (${colorText})</div>
            <div class="player-points">${player.points} ƒëi·ªÉm</div>
          `;
          
          playerListElement.appendChild(playerElement);
        });
        
        // Hi·ªÉn th·ªã ng∆∞·ªùi xem
        const spectators = roomData.spectators || {};
        if (Object.keys(spectators).length > 0) {
          const spectatorsElement = document.createElement('div');
          spectatorsElement.className = 'player';
          
          const spectatorNames = Object.values(spectators).map(s => s.displayName).join(', ');
          spectatorsElement.innerHTML = `
            <div class="player-name">Ng∆∞·ªùi xem: ${spectatorNames}</div>
          `;
          
          playerListElement.appendChild(spectatorsElement);
        }
      }
    }
    
    // H√†m l·∫Øng nghe thay ƒë·ªïi c·ªßa tr√≤ ch∆°i
    function listenToGameChanges(roomId) {
      console.log('B·∫Øt ƒë·∫ßu l·∫Øng nghe thay ƒë·ªïi c·ªßa tr√≤ ch∆°i cho ph√≤ng:', roomId);
      gameStateRef = db.ref('rooms/' + roomId + '/gameState');
      gameStateRef.on('value', snapshot => {
        if (!snapshot.exists()) {
          console.log('Kh√¥ng c√≥ d·ªØ li·ªáu tr√≤ ch∆°i cho ph√≤ng:', roomId);
          return;
        }
        
        try {
          const gameState = snapshot.val();
          console.log('Nh·∫≠n ƒë∆∞·ª£c d·ªØ li·ªáu tr√≤ ch∆°i m·ªõi:', gameState.fen);
          
          // C·∫≠p nh·∫≠t tr·∫°ng th√°i game t·ª´ Firebase
          game = new Chess(gameState.fen);
          
          // ƒê·∫£m b·∫£o b√†n c·ªù ƒë∆∞·ª£c kh·ªüi t·∫°o v√† hi·ªÉn th·ªã
          ensureBoardIsVisible();
          
          // C·∫≠p nh·∫≠t tr·∫°ng th√°i game
          updateGameStatus();
        } catch (error) {
          console.error('L·ªói khi c·∫≠p nh·∫≠t tr·∫°ng th√°i game:', error);
        }
        
        // Ki·ªÉm tra n·∫øu game k·∫øt th√∫c
        try {
          if (game && game.game_over()) {
            console.log('Tr√≤ ch∆°i ƒë√£ k·∫øt th√∫c');
            // Hi·ªÉn th·ªã n√∫t ch∆°i l·∫°i n·∫øu l√† ch·ªß ph√≤ng
            document.getElementById('restart-btn').style.display = isHost ? 'block' : 'none';
            
            // C·∫≠p nh·∫≠t ƒëi·ªÉm s·ªë n·∫øu c√≥ ng∆∞·ªùi th·∫Øng
            if (game.in_checkmate() && !isSpectator) {
              const winner = game.turn() === 'w' ? 'b' : 'w';
              console.log('Ng∆∞·ªùi th·∫Øng:', winner);
              if ((playerColor === winner && !isSpectator) || 
                  (opponentId && winner !== playerColor && isHost)) {
                updatePlayerPoints(winner === 'w' ? 0 : 1);
              }
            }
          } else {
            // ·∫®n n√∫t ch∆°i l·∫°i
            document.getElementById('restart-btn').style.display = 'none';
          }
        } catch (error) {
          console.error('L·ªói khi ki·ªÉm tra tr·∫°ng th√°i k·∫øt th√∫c game:', error);
        }
      });
    }
    
    // H√†m c·∫≠p nh·∫≠t ƒëi·ªÉm s·ªë ng∆∞·ªùi ch∆°i
    function updatePlayerPoints(winnerIndex) {
      if (isSpectator) return;
      
      const roomRef = db.ref('rooms/' + currentRoomId);
      roomRef.once('value', snapshot => {
        if (!snapshot.exists()) return;
        
        const roomData = snapshot.val();
        const players = roomData.players || {};
        const playerIds = Object.keys(players).sort((a, b) => players[a].joinedAt - players[b].joinedAt);
        
        if (playerIds.length !== 2) return;
        
        const winnerId = playerIds[winnerIndex];
        
        // C·∫≠p nh·∫≠t ƒëi·ªÉm s·ªë cho ng∆∞·ªùi th·∫Øng
        const winnerRef = db.ref('rooms/' + currentRoomId + '/players/' + winnerId);
        winnerRef.once('value', snapshot => {
          if (!snapshot.exists()) return;
          
          const winnerData = snapshot.val();
          winnerRef.update({ points: (winnerData.points || 0) + 10 });
        });
        
        // C·∫≠p nh·∫≠t th·ªëng k√™ ng∆∞·ªùi d√πng n·∫øu kh√¥ng ph·∫£i l√† kh√°ch
        if (!currentUser.isGuest) {
          const userRef = db.ref('users/' + winnerId);
          userRef.once('value', snapshot => {
            if (!snapshot.exists()) return;
            
            const userData = snapshot.val();
            userRef.update({
              points: (userData.points || 0) + 10,
              chessWins: (userData.chessWins || 0) + 1,
              totalGames: (userData.totalGames || 0) + 1
            });
          });
          
          // C·∫≠p nh·∫≠t th·ªëng k√™ cho ng∆∞·ªùi thua
          const loserId = playerIds[1 - winnerIndex];
          const loserRef = db.ref('users/' + loserId);
          loserRef.once('value', snapshot => {
            if (!snapshot.exists()) return;
            
            const userData = snapshot.val();
            loserRef.update({
              totalGames: (userData.totalGames || 0) + 1
            });
          });
        }
      });
    }
    
    // H√†m l·∫Øng nghe tin nh·∫Øn chat
    function listenToChat(roomId) {
      chatRef = db.ref('rooms/' + roomId + '/chat');
      chatRef.on('value', snapshot => {
        if (!snapshot.exists()) return;
        
        const chatMessages = snapshot.val();
        const chatMessagesElement = document.getElementById('chatMessages');
        chatMessagesElement.innerHTML = '';
        
        // Hi·ªÉn th·ªã tin nh·∫Øn chat
        Object.keys(chatMessages).forEach(messageId => {
          const message = chatMessages[messageId];
          const messageElement = document.createElement('div');
          messageElement.className = 'message';
          
          if (message.type === 'system') {
            messageElement.classList.add('system-message');
            messageElement.textContent = message.text;
          } else {
            messageElement.innerHTML = `<span class="message-sender">${message.sender}:</span> ${message.text}`;
          }
          
          chatMessagesElement.appendChild(messageElement);
        });
        
        // Cu·ªôn xu·ªëng tin nh·∫Øn m·ªõi nh·∫•t
        chatMessagesElement.scrollTop = chatMessagesElement.scrollHeight;
      });
    }
    
    // H√†m g·ª≠i tin nh·∫Øn chat
    function sendChatMessage() {
      const chatInput = document.getElementById('chatInput');
      const message = chatInput.value.trim();
      
      if (!message) return;
      
      // Th√™m tin nh·∫Øn v√†o Firebase
      const chatRef = db.ref('rooms/' + currentRoomId + '/chat').push();
      chatRef.set({
        sender: currentUser.displayName,
        text: message,
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        type: 'user'
      });
      
      // X√≥a n·ªôi dung input
      chatInput.value = '';
    }
    
    // H√†m hi·ªÉn th·ªã th√¥ng b√°o trong chat
    function showRoomMessage(message) {
      const chatRef = db.ref('rooms/' + currentRoomId + '/chat').push();
      chatRef.set({
        text: message,
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        type: 'system'
      });
    }
    
    // H√†m r·ªùi ph√≤ng
    function leaveRoom() {
      if (!currentRoomId) return;
      
      // X√≥a ng∆∞·ªùi ch∆°i/ng∆∞·ªùi xem kh·ªèi ph√≤ng
      const roomRef = db.ref('rooms/' + currentRoomId);
      
      if (isSpectator) {
        // X√≥a ng∆∞·ªùi xem kh·ªèi ph√≤ng
        roomRef.child('spectators/' + currentUser.uid).remove();
        showRoomMessage(`${currentUser.displayName} ƒë√£ r·ªùi kh·ªèi ph√≤ng (ng∆∞·ªùi xem).`);
        
        // Ki·ªÉm tra xem c√≤n ng∆∞·ªùi ch∆°i n√†o kh√¥ng
        checkAndRemoveEmptyRoom(roomRef);
      } else {
        roomRef.once('value', snapshot => {
          if (!snapshot.exists()) return;
          
          const roomData = snapshot.val();
          const players = roomData.players || {};
          
          // X√≥a ng∆∞·ªùi ch∆°i kh·ªèi ph√≤ng
          roomRef.child('players/' + currentUser.uid).remove();
          
          // Hi·ªÉn th·ªã th√¥ng b√°o
          showRoomMessage(`${currentUser.displayName} ƒë√£ r·ªùi kh·ªèi ph√≤ng.`);
          
          // N·∫øu l√† ch·ªß ph√≤ng, chuy·ªÉn quy·ªÅn ch·ªß ph√≤ng cho ng∆∞·ªùi ch∆°i kh√°c
          if (isHost) {
            const remainingPlayers = Object.keys(players).filter(id => id !== currentUser.uid);
            
            if (remainingPlayers.length > 0) {
              // Chuy·ªÉn quy·ªÅn ch·ªß ph√≤ng cho ng∆∞·ªùi ch∆°i ƒë·∫ßu ti√™n c√≤n l·∫°i
              const newHostId = remainingPlayers[0];
              roomRef.update({ host: newHostId });
              roomRef.child('players/' + newHostId).update({ isHost: true });
              
              showRoomMessage(`${players[newHostId].displayName} ƒë√£ tr·ªü th√†nh ch·ªß ph√≤ng m·ªõi.`);
            } else {
              // N·∫øu kh√¥ng c√≤n ng∆∞·ªùi ch∆°i n√†o, x√≥a ph√≤ng
              roomRef.remove();
            }
          } else {
            // Ki·ªÉm tra xem c√≤n ng∆∞·ªùi ch∆°i n√†o kh√¥ng
            checkAndRemoveEmptyRoom(roomRef);
          }
          
          // N·∫øu tr√≤ ch∆°i ƒëang di·ªÖn ra, c·∫≠p nh·∫≠t tr·∫°ng th√°i ph√≤ng
          if (roomData.status === 'playing') {
            // N·∫øu c√≤n ng∆∞·ªùi ch∆°i, ƒë·∫∑t tr·∫°ng th√°i ph√≤ng v·ªÅ waiting
            const remainingPlayers = Object.keys(players).filter(id => id !== currentUser.uid);
            
            if (remainingPlayers.length > 0) {
              roomRef.update({ status: 'waiting' });
            }
          }
        });
      }
      
      // Ng·ª´ng l·∫Øng nghe c√°c s·ª± ki·ªán Firebase
      if (gameStateRef) gameStateRef.off();
      if (roomPlayersRef) roomPlayersRef.off();
      if (chatRef) chatRef.off();
      
      // X√≥a th√¥ng tin ph√≤ng kh·ªèi localStorage
      localStorage.removeItem('selectedRoomId');
      localStorage.removeItem('isSpectator');
      
      // Chuy·ªÉn h∆∞·ªõng v·ªÅ trang ch·ªß
      window.location.href = 'trangchu.html';
    }
    
    // H√†m b·∫Øt ƒë·∫ßu tr√≤ ch∆°i
    function startGame() {
      if (!isHost) {
        alert('Ch·ªâ ch·ªß ph√≤ng m·ªõi c√≥ th·ªÉ b·∫Øt ƒë·∫ßu tr√≤ ch∆°i!');
        return;
      }
      
      const roomRef = db.ref('rooms/' + currentRoomId);
      roomRef.once('value', snapshot => {
        if (!snapshot.exists()) return;
        
        const roomData = snapshot.val();
        const players = roomData.players || {};
        
        // Ki·ªÉm tra xem c√≥ ƒë·ªß 2 ng∆∞·ªùi ch∆°i kh√¥ng
        if (Object.keys(players).length < 2) {
          alert('C·∫ßn √≠t nh·∫•t 2 ng∆∞·ªùi ch∆°i ƒë·ªÉ b·∫Øt ƒë·∫ßu tr√≤ ch∆°i!');
          return;
        }
        
        // Kh·ªüi t·∫°o tr√≤ ch∆°i m·ªõi
        game = new Chess();
        
        // C·∫≠p nh·∫≠t tr·∫°ng th√°i ph√≤ng
        roomRef.update({
          status: 'playing',
          gameState: {
            fen: game.fen(),
            turn: 'w',
            lastMove: null
          }
        });
        
        // Hi·ªÉn th·ªã th√¥ng b√°o
        showRoomMessage('Tr√≤ ch∆°i ƒë√£ b·∫Øt ƒë·∫ßu!');
        
        // C·∫≠p nh·∫≠t UI
        document.getElementById('waitingRoom').style.display = 'none';
        document.getElementById('gameBoard').style.display = 'block';
        
        // L·∫Øng nghe thay ƒë·ªïi c·ªßa tr√≤ ch∆°i
        listenToGameChanges(currentRoomId);
        
        // ƒê·∫£m b·∫£o b√†n c·ªù ƒë∆∞·ª£c kh·ªüi t·∫°o v√† hi·ªÉn th·ªã
        setTimeout(() => {
          console.log('ƒêang c·ªë g·∫Øng hi·ªÉn th·ªã b√†n c·ªù khi b·∫Øt ƒë·∫ßu tr√≤ ch∆°i...');
          ensureBoardIsVisible();
          
          // Th√™m m·ªôt l·∫ßn ki·ªÉm tra n·ªØa sau 1 gi√¢y ƒë·ªÉ ƒë·∫£m b·∫£o b√†n c·ªù hi·ªÉn th·ªã
          setTimeout(() => {
            console.log('Ki·ªÉm tra l·∫°i b√†n c·ªù sau 1 gi√¢y...');
            ensureBoardIsVisible();
          }, 1000);
        }, 1000);
      });
    }
    
    // H√†m kh·ªüi ƒë·ªông l·∫°i tr√≤ ch∆°i
    function restartGame() {
      if (!isHost) {
        alert('Ch·ªâ ch·ªß ph√≤ng m·ªõi c√≥ th·ªÉ kh·ªüi ƒë·ªông l·∫°i tr√≤ ch∆°i!');
        return;
      }
      
      // Kh·ªüi t·∫°o tr√≤ ch∆°i m·ªõi
      game = new Chess();
      selectedSquare = null;
      
      // C·∫≠p nh·∫≠t tr·∫°ng th√°i game tr√™n Firebase
      const gameStateRef = db.ref('rooms/' + currentRoomId + '/gameState');
      gameStateRef.set({
        fen: game.fen(),
        turn: 'w',
        lastMove: null
      });
      
      // Hi·ªÉn th·ªã th√¥ng b√°o
      showRoomMessage('Tr√≤ ch∆°i ƒë√£ ƒë∆∞·ª£c kh·ªüi ƒë·ªông l·∫°i!');
      
      // ·∫®n n√∫t ch∆°i l·∫°i
      document.getElementById('restart-btn').style.display = 'none';
    }
    
    // H√†m c·∫≠p nh·∫≠t hi·ªÉn th·ªã b√†n c·ªù
    function updateBoard() {
      console.log('C·∫≠p nh·∫≠t hi·ªÉn th·ªã b√†n c·ªù...');
      
      // Ki·ªÉm tra xem game ƒë√£ ƒë∆∞·ª£c kh·ªüi t·∫°o ch∆∞a
      if (!game) {
        console.error('ƒê·ªëi t∆∞·ª£ng game ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o trong updateBoard');
        return;
      }
      
      // Kh·ªüi t·∫°o b√†n c·ªù n·∫øu ch∆∞a c√≥
      if (!document.querySelector('.square')) {
        console.log('Kh·ªüi t·∫°o b√†n c·ªù trong updateBoard');
        initializeBoard();
        return;
      }
      
      // X√≥a t·∫•t c·∫£ qu√¢n c·ªù hi·ªán t·∫°i
      document.querySelectorAll('.square').forEach(square => {
        square.textContent = '';
        square.classList.remove('highlight', 'check', 'last-move', 'possible-move', 'possible-capture');
      });
      
      try {
        // Hi·ªÉn th·ªã qu√¢n c·ªù d·ª±a tr√™n tr·∫°ng th√°i hi·ªán t·∫°i c·ªßa game
        for (let row = 0; row < 8; row++) {
          for (let col = 0; col < 8; col++) {
            const files = ['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h'];
            const ranks = ['8', '7', '6', '5', '4', '3', '2', '1'];
            
            const squareId = files[col] + ranks[row];
            const square = document.querySelector(`[data-square="${squareId}"]`);
            
            try {
              const piece = game.get(squareId);
              
              if (square && piece) {
                square.textContent = getPieceSymbol(piece.type, piece.color);
              }
            } catch (error) {
              console.error('L·ªói khi l·∫•y qu√¢n c·ªù t·∫°i', squareId, error);
            }
          }
        }
      } catch (error) {
        console.error('L·ªói khi c·∫≠p nh·∫≠t b√†n c·ªù:', error);
      }
      
      // ƒê√°nh d·∫•u n∆∞·ªõc ƒëi cu·ªëi c√πng
      const roomRef = db.ref('rooms/' + currentRoomId);
      roomRef.once('value', snapshot => {
        if (!snapshot.exists()) return;
        
        const roomData = snapshot.val();
        const gameState = roomData.gameState || {};
        
        if (gameState.lastMove) {
          const fromSquare = document.querySelector(`[data-square="${gameState.lastMove.from}"]`);
          const toSquare = document.querySelector(`[data-square="${gameState.lastMove.to}"]`);
          
          if (fromSquare) fromSquare.classList.add('last-move');
          if (toSquare) toSquare.classList.add('last-move');
        }
      });
      
      // Ki·ªÉm tra n·∫øu vua ƒëang b·ªã chi·∫øu
      highlightCheck();
    }
    
    // H√†m kh·ªüi t·∫°o b√†n c·ªù
    function initializeBoard() {
      console.log('ƒêang kh·ªüi t·∫°o b√†n c·ªù...');
      const chessBoard = document.getElementById('board');
      
      // Ki·ªÉm tra xem chessBoard c√≥ t·ªìn t·∫°i kh√¥ng
      if (!chessBoard) {
        console.error('Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ b√†n c·ªù v·ªõi id "board"');
        return;
      }
      
      chessBoard.innerHTML = '';
      
      // Ki·ªÉm tra xem game ƒë√£ ƒë∆∞·ª£c kh·ªüi t·∫°o ch∆∞a
      if (!game) {
        console.error('ƒê·ªëi t∆∞·ª£ng game ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o');
        // Kh·ªüi t·∫°o game v·ªõi v·ªã tr√≠ ban ƒë·∫ßu n·∫øu ch∆∞a c√≥
        game = new Chess();
      }
      
      console.log('T·∫°o 64 √¥ c·ªù...');
      // T·∫°o 64 √¥ c·ªù
      for (let row = 0; row < 8; row++) {
        for (let col = 0; col < 8; col++) {
          const square = document.createElement('div');
          square.className = `square ${(row + col) % 2 === 0 ? 'white' : 'black'}`;
          
          // X√°c ƒë·ªãnh t·ªça ƒë·ªô c·ªßa √¥ c·ªù
          const files = ['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h'];
          const ranks = ['8', '7', '6', '5', '4', '3', '2', '1'];
          
          const squareId = files[col] + ranks[row];
          square.setAttribute('data-square', squareId);
          
          // Th√™m s·ª± ki·ªán click cho √¥ c·ªù
          square.addEventListener('click', () => handleSquareClick(squareId));
          
          try {
            // Hi·ªÉn th·ªã qu√¢n c·ªù n·∫øu c√≥
            const piece = game.get(squareId);
            if (piece) {
              square.textContent = getPieceSymbol(piece.type, piece.color);
            }
          } catch (error) {
            console.error('L·ªói khi l·∫•y qu√¢n c·ªù t·∫°i', squareId, error);
          }
          
          chessBoard.appendChild(square);
        }
      }
    }
    
    // H√†m x·ª≠ l√Ω khi ng∆∞·ªùi d√πng click v√†o √¥ c·ªù
    function handleSquareClick(squareId) {
      try {
        // Ki·ªÉm tra game ƒë√£ ƒë∆∞·ª£c kh·ªüi t·∫°o ch∆∞a
        if (!game) {
          console.error('Kh√¥ng th·ªÉ x·ª≠ l√Ω click: game ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o');
          return;
        }
        
        // N·∫øu l√† ng∆∞·ªùi xem ho·∫∑c kh√¥ng ph·∫£i l∆∞·ª£t c·ªßa ng∆∞·ªùi ch∆°i, kh√¥ng l√†m g√¨ c·∫£
        if (isSpectator || game.turn() !== playerColor) return;
        
        const square = document.querySelector(`[data-square="${squareId}"]`);
        if (!square) {
          console.error(`Kh√¥ng t√¨m th·∫•y √¥ c·ªù v·ªõi id: ${squareId}`);
          return;
        }
        
        const piece = game.get(squareId);
        
        // N·∫øu ch∆∞a ch·ªçn √¥ n√†o v√† √¥ hi·ªán t·∫°i c√≥ qu√¢n c·ªù c·ªßa ng∆∞·ªùi ch∆°i
        if (!selectedSquare && piece && piece.color === playerColor) {
          selectedSquare = squareId;
          square.classList.add('highlight');
          
          // Hi·ªÉn th·ªã c√°c n∆∞·ªõc ƒëi h·ª£p l·ªá
          showPossibleMoves(squareId);
        } 
        // N·∫øu ƒë√£ ch·ªçn √¥ v√† click v√†o √¥ kh√°c
        else if (selectedSquare) {
          // N·∫øu click v√†o ch√≠nh √¥ ƒë√£ ch·ªçn, b·ªè ch·ªçn
          if (selectedSquare === squareId) {
            selectedSquare = null;
            clearHighlights();
          } 
          // Th·ª≠ th·ª±c hi·ªán n∆∞·ªõc ƒëi
          else {
            const move = {
              from: selectedSquare,
              to: squareId,
              promotion: 'q' // M·∫∑c ƒë·ªãnh phong h·∫≠u
            };
            
            try {
              // Ki·ªÉm tra xem c√≥ ph·∫£i l√† n∆∞·ªõc ƒëi phong c·∫•p kh√¥ng
              const piece = game.get(selectedSquare);
              if (piece && piece.type === 'p') {
                if ((piece.color === 'w' && squareId[1] === '8') || 
                    (piece.color === 'b' && squareId[1] === '1')) {
                  // Hi·ªÉn th·ªã modal ch·ªçn qu√¢n phong c·∫•p
                  promotionMove = move;
                  showPromotionModal();
                  return;
                }
              }
            } catch (error) {
              console.error('L·ªói khi ki·ªÉm tra n∆∞·ªõc ƒëi phong c·∫•p:', error);
            }
            
            // Th·ª±c hi·ªán n∆∞·ªõc ƒëi
            makeMove(move);
          }
        }
      } catch (error) {
        console.error('L·ªói khi x·ª≠ l√Ω click v√†o √¥ c·ªù:', error);
        selectedSquare = null;
        clearHighlights();
      }
    }
    
    // H√†m hi·ªÉn th·ªã c√°c n∆∞·ªõc ƒëi h·ª£p l·ªá
    function showPossibleMoves(squareId) {
      try {
        if (!game) {
          console.error('Kh√¥ng th·ªÉ hi·ªÉn th·ªã n∆∞·ªõc ƒëi: game ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o');
          return;
        }
        
        const moves = game.moves({ square: squareId, verbose: true });
        
        if (!moves || moves.length === 0) {
          console.log(`Kh√¥ng c√≥ n∆∞·ªõc ƒëi h·ª£p l·ªá cho √¥ ${squareId}`);
          return;
        }
        
        moves.forEach(move => {
          try {
            const targetSquare = document.querySelector(`[data-square="${move.to}"]`);
            if (!targetSquare) {
              console.error(`Kh√¥ng t√¨m th·∫•y √¥ ƒë√≠ch v·ªõi id: ${move.to}`);
              return;
            }
            
            if (move.captured) {
              targetSquare.classList.add('possible-capture');
            } else {
              targetSquare.classList.add('possible-move');
            }
          } catch (error) {
            console.error(`L·ªói khi hi·ªÉn th·ªã n∆∞·ªõc ƒëi ƒë·∫øn ${move.to}:`, error);
          }
        });
      } catch (error) {
        console.error('L·ªói khi hi·ªÉn th·ªã c√°c n∆∞·ªõc ƒëi h·ª£p l·ªá:', error);
      }
    }
    
    // H√†m x√≥a t·∫•t c·∫£ c√°c highlight
    function clearHighlights() {
      document.querySelectorAll('.square').forEach(square => {
        square.classList.remove('highlight', 'possible-move', 'possible-capture');
      });
    }
    
    // H√†m th·ª±c hi·ªán n∆∞·ªõc ƒëi
    function makeMove(move) {
      try {
        if (!game) {
          console.error('Kh√¥ng th·ªÉ th·ª±c hi·ªán n∆∞·ªõc ƒëi: game ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o');
          return;
        }
        
        const result = game.move(move);
        
        // N·∫øu n∆∞·ªõc ƒëi h·ª£p l·ªá
        if (result) {
          try {
            // C·∫≠p nh·∫≠t tr·∫°ng th√°i game tr√™n Firebase
            const gameStateRef = db.ref('rooms/' + currentRoomId + '/gameState');
            gameStateRef.set({
              fen: game.fen(),
              turn: game.turn(),
              lastMove: move
            });
          } catch (error) {
            console.error('L·ªói khi c·∫≠p nh·∫≠t tr·∫°ng th√°i game l√™n Firebase:', error);
          }
          
          selectedSquare = null;
          clearHighlights();
        } else {
          // N·∫øu n∆∞·ªõc ƒëi kh√¥ng h·ª£p l·ªá, b·ªè ch·ªçn √¥ hi·ªán t·∫°i
          selectedSquare = null;
          clearHighlights();
        }
      } catch (error) {
        console.error('L·ªói khi th·ª±c hi·ªán n∆∞·ªõc ƒëi:', error);
        selectedSquare = null;
        clearHighlights();
      }
    }
    
    // H√†m hi·ªÉn th·ªã modal ch·ªçn qu√¢n phong c·∫•p
    function showPromotionModal() {
      try {
        const modal = document.getElementById('promotion-modal');
        if (!modal) {
          console.error('Kh√¥ng t√¨m th·∫•y modal phong c·∫•p');
          return;
        }
        
        modal.style.display = 'flex';
        
        // Th√™m s·ª± ki·ªán click cho c√°c qu√¢n c·ªù phong c·∫•p
        const pieces = document.querySelectorAll('.piece');
        if (!pieces || pieces.length === 0) {
          console.error('Kh√¥ng t√¨m th·∫•y c√°c qu√¢n c·ªù phong c·∫•p');
          return;
        }
        
        pieces.forEach(piece => {
          try {
            piece.onclick = function() {
              try {
                const pieceType = this.getAttribute('data-piece');
                if (!pieceType) {
                  console.error('Kh√¥ng t√¨m th·∫•y thu·ªôc t√≠nh data-piece');
                  return;
                }
                
                if (!promotionMove) {
                  console.error('Kh√¥ng c√≥ th√¥ng tin v·ªÅ n∆∞·ªõc ƒëi phong c·∫•p');
                  return;
                }
                
                promotionMove.promotion = pieceType;
                makeMove(promotionMove);
                modal.style.display = 'none';
              } catch (error) {
                console.error('L·ªói khi x·ª≠ l√Ω click v√†o qu√¢n c·ªù phong c·∫•p:', error);
                modal.style.display = 'none';
              }
            };
          } catch (error) {
            console.error('L·ªói khi th√™m s·ª± ki·ªán click cho qu√¢n c·ªù phong c·∫•p:', error);
          }
        });
      } catch (error) {
        console.error('L·ªói khi hi·ªÉn th·ªã modal phong c·∫•p:', error);
      }
    }
    
    // L·∫•y k√Ω hi·ªáu Unicode cho qu√¢n c·ªù
    function getPieceSymbol(type, color) {
      try {
        if (!type || !color) {
          console.error('Thi·∫øu th√¥ng tin lo·∫°i qu√¢n c·ªù ho·∫∑c m√†u s·∫Øc');
          return '';
        }
        
        const symbols = {
          'w': {
            'p': '‚ôô', 'r': '‚ôñ', 'n': '‚ôò', 'b': '‚ôó', 'q': '‚ôï', 'k': '‚ôî'
          },
          'b': {
            'p': '‚ôü', 'r': '‚ôú', 'n': '‚ôû', 'b': '‚ôù', 'q': '‚ôõ', 'k': '‚ôö'
          }
        };
        
        if (!symbols[color]) {
          console.error(`M√†u s·∫Øc kh√¥ng h·ª£p l·ªá: ${color}`);
          return '';
        }
        
        if (!symbols[color][type]) {
          console.error(`Lo·∫°i qu√¢n c·ªù kh√¥ng h·ª£p l·ªá: ${type}`);
          return '';
        }
        
        return symbols[color][type];
      } catch (error) {
        console.error('L·ªói khi l·∫•y k√Ω hi·ªáu qu√¢n c·ªù:', error);
        return '';
      }
    }
    
    // C·∫≠p nh·∫≠t tr·∫°ng th√°i c·ªßa game
    function updateGameStatus() {
      const statusElement = document.getElementById('status');
      
      let status = '';
      
      if (game.in_checkmate()) {
        status = game.turn() === 'w' ? 'ƒêen th·∫Øng - Tr·∫Øng b·ªã chi·∫øu h·∫øt' : 'Tr·∫Øng th·∫Øng - ƒêen b·ªã chi·∫øu h·∫øt';
      } else if (game.in_draw()) {
        status = 'H√≤a';
        if (game.in_stalemate()) {
          status += ' - B·∫ø t·∫Øc';
        } else if (game.in_threefold_repetition()) {
          status += ' - L·∫∑p l·∫°i v·ªã tr√≠ 3 l·∫ßn';
        } else if (game.insufficient_material()) {
          status += ' - Kh√¥ng ƒë·ªß qu√¢n ƒë·ªÉ chi·∫øu h·∫øt';
        } else {
          status += ' - Lu·∫≠t 50 n∆∞·ªõc ƒëi';
        }
      } else {
        status = 'L∆∞·ª£t c·ªßa: ' + (game.turn() === 'w' ? 'Tr·∫Øng' : 'ƒêen');
        
        if (game.in_check()) {
          status += ' (ƒêang b·ªã chi·∫øu)';
        }
      }
      
      statusElement.textContent = status;
      
      // C·∫≠p nh·∫≠t tr·∫°ng th√°i game trong ph√≤ng
      document.getElementById('gameStatus').textContent = status;
    }
    
    // ƒê√°nh d·∫•u vua ƒëang b·ªã chi·∫øu
    function highlightCheck() {
      try {
        if (!game) {
          console.error('ƒê·ªëi t∆∞·ª£ng game ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o trong highlightCheck');
          return;
        }
        
        if (game.in_check()) {
          const pieces = game.board();
          
          for (let row = 0; row < 8; row++) {
            for (let col = 0; col < 8; col++) {
              const piece = pieces[row][col];
              if (piece && piece.type === 'k' && piece.color === game.turn()) {
                const files = ['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h'];
                const ranks = ['8', '7', '6', '5', '4', '3', '2', '1'];
                
                const squareId = files[col] + ranks[row];
                const square = document.querySelector(`[data-square="${squareId}"]`);
                if (square) {
                  square.classList.add('check');
                } else {
                  console.warn('Kh√¥ng t√¨m th·∫•y √¥ c·ªù cho vua t·∫°i', squareId);
                }
                break;
              }
            }
          }
        }
      } catch (error) {
        console.error('L·ªói khi ƒë√°nh d·∫•u vua b·ªã chi·∫øu:', error);
      }
    }
    
    // Hi·ªÉn th·ªã th√¥ng b√°o trong ph·∫ßn game
    function showMessage(message, type = 'info') {
      const messageDiv = document.getElementById('message');
      messageDiv.textContent = message;
      messageDiv.style.color = type === 'error' ? '#dc3545' : '#28a745';
    }
    
    // H√†m ki·ªÉm tra v√† x√≥a ph√≤ng n·∫øu kh√¥ng c√≤n ng∆∞·ªùi ch∆°i
    function checkAndRemoveEmptyRoom(roomRef) {
      roomRef.once('value', snapshot => {
        if (!snapshot.exists()) return;
        
        const roomData = snapshot.val();
        const players = roomData.players || {};
        
        // N·∫øu kh√¥ng c√≤n ng∆∞·ªùi ch∆°i n√†o, x√≥a ph√≤ng
        if (Object.keys(players).length === 0) {
          console.log('Kh√¥ng c√≤n ng∆∞·ªùi ch∆°i n√†o, x√≥a ph√≤ng');
          roomRef.remove();
        }
      });
    }
    
    // H√†m ki·ªÉm tra v√† hi·ªÉn th·ªã b√†n c·ªù
    function ensureBoardIsVisible() {
      console.log('ƒê·∫£m b·∫£o b√†n c·ªù hi·ªÉn th·ªã...');
      
      // Ki·ªÉm tra xem b√†n c·ªù ƒë√£ ƒë∆∞·ª£c hi·ªÉn th·ªã ch∆∞a
      const boardElement = document.getElementById('board');
      const squareElements = document.querySelectorAll('.square');
      
      console.log('S·ªë √¥ c·ªù hi·ªán t·∫°i:', squareElements.length);
      
      // N·∫øu kh√¥ng c√≥ √¥ c·ªù ho·∫∑c s·ªë √¥ c·ªù kh√¥ng ƒë·ªß 64 √¥
      if (!squareElements.length || squareElements.length < 64) {
        console.log('Kh·ªüi t·∫°o b√†n c·ªù v√¨ kh√¥ng t√¨m th·∫•y ƒë·ªß √¥ c·ªù');
        
        // X√≥a b√†n c·ªù c≈© n·∫øu c√≥
        if (boardElement) {
          boardElement.innerHTML = '';
        }
        
        // Kh·ªüi t·∫°o l·∫°i b√†n c·ªù
        initializeBoard();
      }
      
      console.log('C·∫≠p nh·∫≠t hi·ªÉn th·ªã b√†n c·ªù');
      updateBoard();
    }
    
    // X·ª≠ l√Ω khi ng∆∞·ªùi d√πng ƒë√≥ng tab ho·∫∑c r·ªùi trang
    window.addEventListener('beforeunload', () => {
      // R·ªùi ph√≤ng khi ƒë√≥ng tab
      leaveRoom();
    });
  </script>
</body>
</html>